<!DOCTYPE html><style>body {
  cursor: url(https://cdn.jsdelivr.net/gh/sviptzk/HexoStaticFile@latest/Hexo/img/default.cur),
  default;
}

a,
img {
  cursor: url(https://cdn.jsdelivr.net/gh/sviptzk/HexoStaticFile@latest/Hexo/img/pointer.cur),
  default;
}

::-webkit-scrollbar-thumb {
  background-color: dodgerblue;
  background-image: -webkit-linear-gradient(
    45deg,
    rgba(255, 255, 255, .4) 25%,
    transparent 25%,
    transparent 50%, rgba(255, 255, 255, .4) 50%,
    rgba(255, 255, 255, .4) 75%,
    transparent 75%,
    transparent);
  border-radius: 3em;
}

::-webkit-scrollbar-track {
  background-color: #DEDEDE;
  border-radius: 3em;
}

::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}</style><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/favicon-16x16.png?v=2.6.2" type="image/png" sizes="16x16"><link rel="icon" href="/favicon-32x32.png?v=2.6.2" type="image/png" sizes="32x32"><meta name="description" content="SpringCloud微服务入门，包括：注册中心（Eureka、Nacos）、负载均衡（Ribbon）、远程调用（Feign）、网关（Gateway）、消息队列（RabbitMQ）">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringCloud微服务基础">
<meta property="og:url" content="http://taoyyz.github.io/2021/10/14/SpringCloud%E5%BE%AE%E6%9C%8D%E5%8A%A1/index.html">
<meta property="og:site_name" content="欢迎光临taoyyz的Blog">
<meta property="og:description" content="SpringCloud微服务入门，包括：注册中心（Eureka、Nacos）、负载均衡（Ribbon）、远程调用（Feign）、网关（Gateway）、消息队列（RabbitMQ）">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210922233946164.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210922234059562.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210922234411742.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210923001208086.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210923002805853.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210923003141626.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210923133841456.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210923134248868.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210923164855406.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210923170719968.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210923170909592.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210923223212010.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210923225135114.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210923231151320.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210923232925983.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210924002931392.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210924003021042.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210924003043575.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210924003227310.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210924003539852.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210924003635303.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210924004140684.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210924004158405.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210924004808150.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210924005316140.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210924134339815.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210924134537042.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210924165637880.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210924171537858.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210924174006951.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210925001827900.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210925012202746.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210925021404029.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210925022012411.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210925023446855.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210925121436208.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210925122047188.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210925122506478.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210925122544884.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210925125205808.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210925125334508.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210925125513417.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210925131403334.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210925131840527.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210925132058849.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210925133523283.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210925133647641.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210925134110998.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210925135753346.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210925140135506.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210925143511913.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210925145341333.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210925150025819.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210925150035328.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210925152048065.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210929010842471.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210929010920818.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210929011140311.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210929011726020.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210929011911137.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210929012919073.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210930172348642.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210930172431626.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210930172958391.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210930173119852.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210930175724961.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210930180247019.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210930210805550.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210930220240837.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210930220634785.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20210930233018894.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20211001003507962.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20211001003712624.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20211001004124505.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20211001004924838.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20211001154451836.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20211001164327103.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20211001165453866.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20211001165830038.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20211001171259343.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20211001180909842.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20211001181140583.png">
<meta property="og:image" content="http://taoyyz.github.io/images/image-20211001214355743.png">
<meta property="article:published_time" content="2021-10-14T10:02:17.000Z">
<meta property="article:modified_time" content="2023-09-28T16:55:05.254Z">
<meta property="article:author" content="taoyyz小陶">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="Spring">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://taoyyz.github.io/images/image-20210922233946164.png"><title>SpringCloud微服务基础 | 欢迎光临taoyyz的Blog</title><link ref="canonical" href="http://taoyyz.github.io/2021/10/14/SpringCloud%E5%BE%AE%E6%9C%8D%E5%8A%A1/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.2"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":true},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"carbon","highlight":"light","wordWrap":true},
  reward: true,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: true,
  pjax: {"avoidBanner":false},
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"复制","copySuccess":"复制成功","copyError":"复制失败"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.4.0"></head><body><canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;"></canvas><script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script><script type="text/javascript" src="/js/firework.js"></script><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">首页</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">归档</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">分类</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">标签</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/links/"><span class="header-nav-menu-item__icon"><i class="fas fa-link"></i></span><span class="header-nav-menu-item__text">资源和链接</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/about/"><span class="header-nav-menu-item__icon"><i class="far fa-address-card"></i></span><span class="header-nav-menu-item__text">关于</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">搜索</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">欢迎光临taoyyz的Blog</div><div class="header-banner-info__subtitle"></div></div><div class="header-banner-arrow"><div class="header-banner-arrow__icon"><i class="fas fa-angle-down"></i></div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">SpringCloud微服务基础</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-10-14</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2023-09-29</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">8.5k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">63分</span></span></div></header><div class="post-body"><p><font size="7" face="微软雅黑">SpringCloud</font></p>

        <h1 id="导学">
          <a href="#导学" class="heading-link"><i class="fas fa-link"></i></a><a href="#导学" class="headerlink" title="导学"></a>导学</h1>
      <p><strong>微服务技术栈</strong>：</p>
<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210922233946164.png" alt="image-20210922233946164">
      </p>
<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210922234059562.png" alt="image-20210922234059562">
      </p>
<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210922234411742.png" alt="image-20210922234411742">
      </p>

        <h1 id="概念">
          <a href="#概念" class="heading-link"><i class="fas fa-link"></i></a><a href="#概念" class="headerlink" title="概念"></a>概念</h1>
      
        <h2 id="架构">
          <a href="#架构" class="heading-link"><i class="fas fa-link"></i></a><a href="#架构" class="headerlink" title="架构"></a>架构</h2>
      <ul>
<li><strong>单体架构</strong>：将业务的所有功能集中在一个项目中开发，打成一个包部署<ul>
<li>优点：<ul>
<li>架构简单</li>
<li>部署成本低</li>
</ul>
</li>
<li>缺点：<ul>
<li>耦合度高</li>
</ul>
</li>
</ul>
</li>
<li><strong>分布式架构</strong>：根据业务功能对系统进行拆分，每个业务模块作为独立项目开发，称为一个<em><strong>服务</strong></em><ul>
<li>优点：<ul>
<li>降低耦合度</li>
<li>有利于服务升级拓展</li>
</ul>
</li>
<li>缺点：<ul>
<li>要考虑<em><strong>服务治理</strong></em><ol>
<li>服务拆分粒度如何？</li>
<li>服务集群地址如何维护？</li>
<li>服务之间如何实现远程调用？</li>
<li>服务健康状态如何感知？</li>
</ol>
</li>
<li>架构非常复杂：运维、监控、部署难度提高</li>
</ul>
</li>
</ul>
</li>
</ul>

        <h2 id="微服务：">
          <a href="#微服务：" class="heading-link"><i class="fas fa-link"></i></a><a href="#微服务：" class="headerlink" title="微服务："></a>微服务：</h2>
      <blockquote>
<p>微服务是一种经过良好架构设计的分布式架构方案</p>
</blockquote>
<ul>
<li>微服务架构的特征：
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210923001208086.png" alt="image-20210923001208086" style="zoom:50%;">
      <ul>
<li>单一职责：微服务拆分粒度更小，每一个服务都对应唯一的业务能力，做到单一职责，避免重复业务开发</li>
<li>面向服务：微服务对外暴露业务接口</li>
<li>自治：团队独立、技术独立、数据独立、部署独立</li>
<li>隔离性强：服务调用做好隔离、容错、降级，避免出现级联问题</li>
</ul>
</li>
</ul>

        <h2 id="微服务结构">
          <a href="#微服务结构" class="heading-link"><i class="fas fa-link"></i></a><a href="#微服务结构" class="headerlink" title="微服务结构"></a>微服务结构</h2>
      <blockquote>
<p>微服务这种方案需要技术框架来落地，国内最知名的就是SpringCloud和阿里巴巴的Dubbo</p>
</blockquote>
<div class="table-container"><table>
<thead>
<tr>
<th align="center"></th>
<th align="center">Dubbo</th>
<th align="center">SpringCloud</th>
<th align="center">SpringCloudAlibaba</th>
</tr>
</thead>
<tbody><tr>
<td align="center">注册中心</td>
<td align="center">zookeeper、Redis</td>
<td align="center">Eureka、Consul</td>
<td align="center">Nacos、Eureka</td>
</tr>
<tr>
<td align="center">服务远程调用</td>
<td align="center">Dubbo协议</td>
<td align="center">Feign（http协议）</td>
<td align="center">Dubbo、Feign</td>
</tr>
<tr>
<td align="center">配置中心</td>
<td align="center">无</td>
<td align="center">SpringCloudConfig</td>
<td align="center">SpringCloudConfig、Nacos</td>
</tr>
<tr>
<td align="center">服务网关</td>
<td align="center">无</td>
<td align="center">SpringCloudGateway、Zuul</td>
<td align="center">SpringCloudGateway、Zuul</td>
</tr>
<tr>
<td align="center">服务监控和保护</td>
<td align="center">dubbo-admin，功能弱</td>
<td align="center">Hystrix</td>
<td align="center">Sentinel</td>
</tr>
</tbody></table></div>

        <h2 id="SpringCloud">
          <a href="#SpringCloud" class="heading-link"><i class="fas fa-link"></i></a><a href="#SpringCloud" class="headerlink" title="SpringCloud"></a>SpringCloud</h2>
      <ul>
<li>SpringCloud是目前国内使用最广泛的微服务框架</li>
<li>SpringCloud继承了各种微服务功能组件，并基于SpringBoot实现了这些组件的自动装配，从而提供了良好的开箱即用体验</li>
</ul>

        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210923002805853.png" alt="image-20210923002805853" style="zoom: 50%;">
      

<ul>
<li>SpringCloud与SpringBoot的版本兼容关系：（本教程使用Hoxton.SR10版本）</li>
</ul>

        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210923003141626.png" alt="image-20210923003141626" style="zoom:50%;">
       


        <h2 id="服务拆分">
          <a href="#服务拆分" class="heading-link"><i class="fas fa-link"></i></a><a href="#服务拆分" class="headerlink" title="服务拆分"></a>服务拆分</h2>
      <ul>
<li>注意事项：<ol>
<li>不同微服务，不要重复开发相同的业务</li>
<li>微服务数据独立，不要访问其他微服务的数据库</li>
<li>微服务可以将自己的业务暴露为接口，供其他微服务调用</li>
</ol>
</li>
</ul>

        <h2 id="微服务远程调用">
          <a href="#微服务远程调用" class="heading-link"><i class="fas fa-link"></i></a><a href="#微服务远程调用" class="headerlink" title="微服务远程调用"></a>微服务远程调用</h2>
      <ol>
<li><p>注册RestTemplate为Bean</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span> <span class="comment">//随意在配置类中注册Bean，建议在SpringBoot启动类</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
<li><p>服务远程调用RestTemplate</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderMapper orderMapper;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate; <span class="comment">//注入此Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Order <span class="title">queryOrderById</span><span class="params">(Long orderId)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1.查询订单</span></span><br><span class="line">        Order order = orderMapper.findById(orderId);</span><br><span class="line"><span class="comment">//        2.根据order对象的userId查询对应的用户信息，把userId发送到对应的url查询并封装</span></span><br><span class="line">        Long userId = order.getUserId();</span><br><span class="line">        User user = restTemplate.getForObject(<span class="string">&quot;http://localhost:8081/user/&quot;</span> + userId, User.class);</span><br><span class="line"><span class="comment">//        3.封装数据</span></span><br><span class="line">        order.setUser(user);</span><br><span class="line">        <span class="comment">// 4.返回</span></span><br><span class="line">        <span class="keyword">return</span> order;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
</ol>
<p><strong>调用方式：</strong></p>
<ul>
<li>基于RestTemplate发起http请求实现远程调用</li>
<li>http请求做远程调用是<em>与语言无关</em>的调用，只需要知道对方的url（ip、端口、接口路径、请求参数）即可</li>
</ul>

        <h1 id="Eureka注册中心">
          <a href="#Eureka注册中心" class="heading-link"><i class="fas fa-link"></i></a><a href="#Eureka注册中心" class="headerlink" title="Eureka注册中心"></a>Eureka注册中心</h1>
      
        <h2 id="提供者与消费者">
          <a href="#提供者与消费者" class="heading-link"><i class="fas fa-link"></i></a><a href="#提供者与消费者" class="headerlink" title="提供者与消费者"></a>提供者与消费者</h2>
      <ul>
<li>服务提供者：一次业务中，被其他微服务调用的服务</li>
<li>服务消费者：一次业务中，调用其他微服务的服务</li>
</ul>
<p>提供者与消费者角色是相对的，一个服务即可以是提供者，又可以是消费者</p>

        <h2 id="Eureka的作用">
          <a href="#Eureka的作用" class="heading-link"><i class="fas fa-link"></i></a><a href="#Eureka的作用" class="headerlink" title="Eureka的作用"></a>Eureka的作用</h2>
      <p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210923133841456.png" alt="image-20210923133841456">
      </p>

        <h2 id="服务调用出现的问题">
          <a href="#服务调用出现的问题" class="heading-link"><i class="fas fa-link"></i></a><a href="#服务调用出现的问题" class="headerlink" title="服务调用出现的问题"></a>服务调用出现的问题</h2>
      <ul>
<li>消费者如何获取提供者的具体信息？<ul>
<li>服务提供者启动时向Eureka注册自己的信息</li>
<li>Eureka保存这些信息</li>
<li>消费者根据服务名称向Eureka拉取提供者信息</li>
</ul>
</li>
<li>如果有多个服务提供者，消费者该如何选择？<ul>
<li>服务消费者利用负载均衡算法，从服务列表中挑选一个</li>
</ul>
</li>
<li>消费者如何感知服务提供者健康状态？<ul>
<li>服务提供者会每隔30秒向EurekaServer发送心跳请求，报告健康状态</li>
<li>Eureka会更新记录服务列表信息，心跳不正常的会被剔除</li>
<li>消费者可以拉取到最新的信息
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210923134248868.png" alt="image-20210923134248868">
      </li>
</ul>
</li>
</ul>

        <h2 id="快速入门">
          <a href="#快速入门" class="heading-link"><i class="fas fa-link"></i></a><a href="#快速入门" class="headerlink" title="快速入门"></a>快速入门</h2>
      
        <h3 id="1-搭建EurekaServer服务">
          <a href="#1-搭建EurekaServer服务" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-搭建EurekaServer服务" class="headerlink" title="1.搭建EurekaServer服务"></a>1.搭建EurekaServer服务</h3>
      <ol>
<li><p>创建项目，引入<code>spring-cloud-starter-netflix-eureka-server</code>的依赖</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></div></figure></li>
<li><p>编写启动类，添加<code>@EnabledEurekaServer</code>注解</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(EurekaApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
<li><p>在SpringBoot核心配置文件配置Eureka服务端</p>
<figure class="highlight yaml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8082</span> <span class="comment"># Eureka的SpringBoot服务端口</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eurekaserver</span> <span class="comment"># Eureka的服务名称</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8082/eureka</span> <span class="comment"># Eureka的地址信息</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span> <span class="comment"># 关闭从Eureka服务器获取信息</span></span><br></pre></td></tr></table></div></figure></li>
</ol>

        <h3 id="2-注册service到EurekaServer（服务注册）">
          <a href="#2-注册service到EurekaServer（服务注册）" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-注册service到EurekaServer（服务注册）" class="headerlink" title="2.注册service到EurekaServer（服务注册）"></a>2.注册service到EurekaServer（服务注册）</h3>
      <ol>
<li><p>在需要注册为Eureka客户端的项目中引入<code>spring-cloud-starter-netflix-eureka-client</code>的依赖</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></div></figure></li>
<li><p>在SpringBoot核心配置文件中配置Eureka客户端</p>
<figure class="highlight yaml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">orderservice</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8082/eureka</span></span><br></pre></td></tr></table></div></figure></li>
</ol>

        <h3 id="3-拉取service从EurekaServer（服务发现）">
          <a href="#3-拉取service从EurekaServer（服务发现）" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-拉取service从EurekaServer（服务发现）" class="headerlink" title="3.拉取service从EurekaServer（服务发现）"></a>3.拉取service从EurekaServer（服务发现）</h3>
      <blockquote>
<p>服务拉取是基于服务名称获取服务列表，然后再对服务列表做负载均衡</p>
</blockquote>
<ol>
<li><p>修改service中要访问的url路径，用服务名代替ip、端口</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">User user = restTemplate.</span><br><span class="line">    getForObject(<span class="string">&quot;http://userservice/user/&quot;</span> + userId, User.class);</span><br></pre></td></tr></table></div></figure></li>
<li><p>在service的启动类中产生@RestTemplate的Bean上打上@LoadBalanced负载均衡注解</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@LoadBalanced</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
</ol>

        <h1 id="Ribbon负载均衡">
          <a href="#Ribbon负载均衡" class="heading-link"><i class="fas fa-link"></i></a><a href="#Ribbon负载均衡" class="headerlink" title="Ribbon负载均衡"></a>Ribbon负载均衡</h1>
      
        <h2 id="负载均衡原理">
          <a href="#负载均衡原理" class="heading-link"><i class="fas fa-link"></i></a><a href="#负载均衡原理" class="headerlink" title="负载均衡原理"></a>负载均衡原理</h2>
      <p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210923164855406.png" alt="image-20210923164855406">
      </p>
<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210923170719968.png" alt="image-20210923170719968">
      </p>

        <h2 id="负载均衡策略">
          <a href="#负载均衡策略" class="heading-link"><i class="fas fa-link"></i></a><a href="#负载均衡策略" class="headerlink" title="负载均衡策略"></a>负载均衡策略</h2>
      <p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210923170909592.png" alt="image-20210923170909592">
      </p>
<p><strong>默认实现是ZoneAvoidanceRule，是一种轮询方案</strong></p>
<p><strong>通过定义IRule实现可以修改负载均衡规则，有两种方式：</strong></p>
<ul>
<li><p>代码方式：在service启动类中定义一个@Bean方法返回一个IRule实现类</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> IRule <span class="title">randomRule</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RandomRule();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
<li><p>配置文件方式：在service所在的SpringBoot核心配置文件中配置规则</p>
<figure class="highlight yaml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">userserivce:</span></span><br><span class="line">  <span class="attr">ribbon:</span></span><br><span class="line">    <span class="attr">NFLoadBalancerRuleClassName:</span> <span class="string">com.netflix.loadbalancer.RandomRule</span> <span class="comment"># 负载均衡的规则</span></span><br></pre></td></tr></table></div></figure></li>
</ul>

        <h2 id="懒加载和饥饿加载">
          <a href="#懒加载和饥饿加载" class="heading-link"><i class="fas fa-link"></i></a><a href="#懒加载和饥饿加载" class="headerlink" title="懒加载和饥饿加载"></a>懒加载和饥饿加载</h2>
      <blockquote>
<p>Ribbon默认采用懒加载，即第一次访问时才会创建LoadBalanceClient，请求时间会比较长</p>
<p>而饥饿加载则会在项目启动时创建，降低第一次访问的耗时</p>
</blockquote>
<p>开启饥饿加载：</p>
<figure class="highlight yaml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="attr">eager-load:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment">#开启饥饿加载</span></span><br><span class="line">    <span class="attr">clients:</span> <span class="comment">#userservice #指定对userservice这个服务进行饥饿加载</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">userservice</span></span><br><span class="line">      <span class="comment">#- 其他service ，因为clients是一个List&lt;String&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210923223212010.png" alt="image-20210923223212010">
      </p>

        <h1 id="Nacos注册中心">
          <a href="#Nacos注册中心" class="heading-link"><i class="fas fa-link"></i></a><a href="#Nacos注册中心" class="headerlink" title="Nacos注册中心"></a>Nacos注册中心</h1>
      <blockquote>
<p>Nacos是阿里巴巴的产品，现在是SpringCloud的一个组件。相比Eureka功能更丰富</p>
</blockquote>

        <h2 id="快速入门-1">
          <a href="#快速入门-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#快速入门-1" class="headerlink" title="快速入门"></a>快速入门</h2>
      
        <h3 id="1-安装Nacos">
          <a href="#1-安装Nacos" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-安装Nacos" class="headerlink" title="1.安装Nacos"></a>1.安装Nacos</h3>
      <ul>
<li><p>windows环境：</p>
<ol>
<li><p>解压Nacos的zip包</p>
</li>
<li><p>启动Nacos安装目录下的bin目录下的startup.cmd</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">startup.cmd -m standalone</span><br></pre></td></tr></table></div></figure></li>
<li><p>访问Nacos管理页面：默认用户名密码均为<code>nacos</code>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210923225135114.png" alt="image-20210923225135114" style="zoom: 80%;">
      </p>
</li>
</ol>
</li>
<li><p>docker环境</p>
<ol>
<li><p>拉取nacos server的镜像</p>
</li>
<li><p>创建配置文件</p>
<figure class="highlight sh"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir /home/nacos/init.d</span><br><span class="line">mkdir /home/nacos/logs</span><br><span class="line">vim /home/nacos/init.d/custom.properties</span><br></pre></td></tr></table></div></figure>

<p>配置文件内容：</p>
<figure class="highlight properties"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">server.contextPath</span>=<span class="string">/nacos</span></span><br><span class="line"><span class="meta">server.servlet.contextPath</span>=<span class="string">/nacos</span></span><br><span class="line"><span class="meta">server.port</span>=<span class="string">8848</span></span><br><span class="line"></span><br><span class="line"><span class="meta">spring.datasource.platform</span>=<span class="string">mysql</span></span><br><span class="line"></span><br><span class="line"><span class="meta">db.num</span>=<span class="string">1</span></span><br><span class="line"><span class="meta">db.url.0</span>=<span class="string">jdbc:mysql://120.79.141.53:3307/nacos?#characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true</span></span><br><span class="line"><span class="meta">db.user</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">db.password</span>=<span class="string">123</span></span><br><span class="line"></span><br><span class="line"><span class="meta">nacos.cmdb.dumpTaskInterval</span>=<span class="string">3600</span></span><br><span class="line"><span class="meta">nacos.cmdb.eventTaskInterval</span>=<span class="string">10</span></span><br><span class="line"><span class="meta">nacos.cmdb.labelTaskInterval</span>=<span class="string">300</span></span><br><span class="line"><span class="meta">nacos.cmdb.loadDataAtStart</span>=<span class="string">false</span></span><br><span class="line"></span><br><span class="line"><span class="meta">management.metrics.export.elastic.enabled</span>=<span class="string">false</span></span><br><span class="line"><span class="meta">management.metrics.export.influx.enabled</span>=<span class="string">false</span></span><br><span class="line"></span><br><span class="line"><span class="meta">server.tomcat.accesslog.enabled</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">server.tomcat.accesslog.pattern</span>=<span class="string">%h %l %u %t &quot;%r&quot; %s %b %D %&#123;User-Agent&#125;i</span></span><br><span class="line"></span><br><span class="line"><span class="meta">nacos.security.ignore.urls</span>=<span class="string">/,/**/*.css,/**/*.js,/**/*.html,/**/*.map,/**/*.svg,/**/*.png,/**/*.ico,/console-fe/public/**,/v1/auth/login,/v1/console/health/**,/v1/cs/**,/v1/ns/**,/v1/cmdb/**,/actuator/**,/v1/console/server/**</span></span><br><span class="line"><span class="meta">nacos.naming.distro.taskDispatchThreadCount</span>=<span class="string">1</span></span><br><span class="line"><span class="meta">nacos.naming.distro.taskDispatchPeriod</span>=<span class="string">200</span></span><br><span class="line"><span class="meta">nacos.naming.distro.batchSyncKeyCount</span>=<span class="string">1000</span></span><br><span class="line"><span class="meta">nacos.naming.distro.initDataRatio</span>=<span class="string">0.9</span></span><br><span class="line"><span class="meta">nacos.naming.distro.syncRetryDelay</span>=<span class="string">5000</span></span><br><span class="line"><span class="meta">nacos.naming.data.warmup</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">nacos.naming.expireInstance</span>=<span class="string">true</span></span><br></pre></td></tr></table></div></figure></li>
<li><p>启动容器</p>
<figure class="highlight sh"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">docker run \</span><br><span class="line">    --name nacos -d \</span><br><span class="line">    -p 8848:8848 \</span><br><span class="line">    --privileged=<span class="literal">true</span> \</span><br><span class="line">    --restart=always \</span><br><span class="line">    -e JVM_XMS=128m \</span><br><span class="line">    -e JVM_XMX=128m \</span><br><span class="line">    -e MODE=standalone \</span><br><span class="line">    -e PREFER_HOST_MODE=hostname \</span><br><span class="line">    -v /home/nacos/logs:/home/nacos/logs \</span><br><span class="line">    -v /home/nacos/init.d/custom.properties:/home/nacos/init.d/custom.properties \</span><br><span class="line">    nacos/nacos-server</span><br></pre></td></tr></table></div></figure></li>
</ol>
</li>
</ul>

        <h3 id="2-服务注册与发现">
          <a href="#2-服务注册与发现" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-服务注册与发现" class="headerlink" title="2.服务注册与发现"></a>2.服务注册与发现</h3>
      <ol>
<li><p>在父工程添加spring-cloud-alibaba的管理依赖</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></div></figure></li>
<li><p>去掉service的Eureka依赖</p>
</li>
<li><p>添加Nacos的客户端依赖</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--Eureka客户端依赖--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;dependency&gt;</span></span><br><span class="line"><span class="comment">        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span></span><br><span class="line"><span class="comment">        &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;</span></span><br><span class="line"><span class="comment">    &lt;/dependency&gt;--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--nacos依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></div></figure></li>
<li><p>在service的SpringBoot核心配置文件中配置nacos的地址</p>
<figure class="highlight yaml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#nacos的服务地址,默认</span></span><br></pre></td></tr></table></div></figure></li>
</ol>
<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210923231151320.png" alt="image-20210923231151320">
      </p>

        <h3 id="3-服务集群属性">
          <a href="#3-服务集群属性" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-服务集群属性" class="headerlink" title="3.服务集群属性"></a>3.服务集群属性</h3>
      <ol>
<li><p>修改service的SpringBoot核心配置文件</p>
<figure class="highlight yaml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">cluster-name:</span> <span class="string">shanghai</span></span><br></pre></td></tr></table></div></figure></li>
<li><p>Nacos控制台可以查看集群</p>
</li>
</ol>
<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210923232925983.png" alt="image-20210923232925983">
      </p>

        <h3 id="4-NacosRule服务集群优先级">
          <a href="#4-NacosRule服务集群优先级" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-NacosRule服务集群优先级" class="headerlink" title="4.NacosRule服务集群优先级"></a>4.NacosRule服务集群优先级</h3>
      <p><strong>配置负载均衡的规则为NacosRule：</strong></p>
<ul>
<li>java配置</li>
</ul>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> IRule <span class="title">nacosRule</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> NacosRule();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<ul>
<li>service的SpringBoot核心配置文件中配置</li>
</ul>
<figure class="highlight yaml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">userserivce:</span></span><br><span class="line">  <span class="attr">ribbon:</span></span><br><span class="line">    <span class="attr">NFLoadBalancerRuleClassName:</span> <span class="string">com.alibaba.cloud.nacos.ribbon.NacosRule</span> <span class="comment">#规则</span></span><br></pre></td></tr></table></div></figure>

<p><strong>NacosRule的规则如下：</strong></p>
<ul>
<li><strong>优先选择同集群的服务实例列表</strong></li>
<li>本地集群找不到提供者，才会去其他集群寻找，并且会报警告</li>
<li>确定了可用实例列表后，再采用随机负载均衡挑选实例</li>
</ul>

        <h3 id="5-根据权重负载均衡">
          <a href="#5-根据权重负载均衡" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-根据权重负载均衡" class="headerlink" title="5.根据权重负载均衡"></a>5.根据权重负载均衡</h3>
      <ol>
<li><p>在Nacos控制台设置实例的权重值</p>

        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210924002931392.png" alt="image-20210924002931392" style="zoom: 80%;">
       </li>
<li><p>设置此实例的权重（取值[0,1]之间）：
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210924003021042.png" alt="image-20210924003021042" style="zoom:67%;">
      </p>
</li>
</ol>
<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210924003043575.png" alt="image-20210924003043575">
      </p>

        <h3 id="6-环境隔离namespace">
          <a href="#6-环境隔离namespace" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-环境隔离namespace" class="headerlink" title="6.环境隔离namespace"></a>6.环境隔离namespace</h3>
      <blockquote>
<p>Nacos中服务存储和数据存储的最外层都是一个名为namespace的东西，用来做最外层隔离</p>
</blockquote>

        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210924003227310.png" alt="image-20210924003227310" style="zoom: 40%;">
      

<ol>
<li><p>在Nacos控制台创建namespace，用来隔离不同环境</p>

        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210924003539852.png" alt="image-20210924003539852" style="zoom:80%;">
       </li>
<li><p>填写namespace信息</p>

        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210924003635303.png" alt="image-20210924003635303" style="zoom:80%;">
       </li>
<li><p>上述步骤之后会生成一个命名空间以及id</p>
</li>
<li><p>修改service的SpringBoot核心配置文件，添加namespace</p>
<figure class="highlight yaml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">orderservice</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#nacos的服务地址</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">cluster-name:</span> <span class="string">hangzhou</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">a67c6300-08fb-4f64-9e07-4969f8e95474</span> <span class="comment">#命名空间的id</span></span><br></pre></td></tr></table></div></figure></li>
<li><p>此时启动service会导致此service位于指定的命名空间下</p>
</li>
<li><p>访问此orderservice由于namespace不同，会导致找不到userservice</p>
<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210924004140684.png" alt="image-20210924004140684">
      </p>
</li>
</ol>
<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210924004158405.png" alt="image-20210924004158405">
      </p>

        <h2 id="Nacos注册中心细节分析">
          <a href="#Nacos注册中心细节分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#Nacos注册中心细节分析" class="headerlink" title="Nacos注册中心细节分析"></a>Nacos注册中心细节分析</h2>
      <p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210924004808150.png" alt="image-20210924004808150">
      </p>

        <h3 id="临时实例和非临时实例">
          <a href="#临时实例和非临时实例" class="heading-link"><i class="fas fa-link"></i></a><a href="#临时实例和非临时实例" class="headerlink" title="临时实例和非临时实例"></a>临时实例和非临时实例</h3>
      <p>服务注册到Nacos时，可以选择临时实例或非临时实例，通过配置SpringBoot核心配置文件：</p>
<figure class="highlight yaml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">ephemeral:</span> <span class="literal">false</span> <span class="comment">#是否临时实例</span></span><br></pre></td></tr></table></div></figure>

<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210924005316140.png" alt="image-20210924005316140">
      </p>

        <h2 id="Nacos配置管理">
          <a href="#Nacos配置管理" class="heading-link"><i class="fas fa-link"></i></a><a href="#Nacos配置管理" class="headerlink" title="Nacos配置管理"></a>Nacos配置管理</h2>
      
        <h3 id="配置Nacos配置">
          <a href="#配置Nacos配置" class="heading-link"><i class="fas fa-link"></i></a><a href="#配置Nacos配置" class="headerlink" title="配置Nacos配置"></a>配置Nacos配置</h3>
      <ol>
<li><p>在Nacos管理页面添加配置</p>
<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210924134339815.png" alt="image-20210924134339815">
      </p>
</li>
<li><p>填写配置信息</p>
<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210924134537042.png" alt="image-20210924134537042">
      </p>
</li>
</ol>

        <h3 id="读取Nacos配置">
          <a href="#读取Nacos配置" class="heading-link"><i class="fas fa-link"></i></a><a href="#读取Nacos配置" class="headerlink" title="读取Nacos配置"></a>读取Nacos配置</h3>
      <ol>
<li><p>引入Nacos的配置管理客户端依赖</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--nacos的配置管理依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></div></figure></li>
<li><p>在service的resources目录中添加一个bootstrap.yml引导文件，优先级高于application.yml</p>
<figure class="highlight yaml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">userservice</span> <span class="comment">#服务名</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span> <span class="comment">#配置环境名</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#nacos地址</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span> <span class="comment">#配置文件后缀名</span></span><br></pre></td></tr></table></div></figure></li>
<li><p>读取Nacos配置信息</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value(&quot;$&#123;pattern.dateformat&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String dateFormat;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(&quot;now&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getNow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> LocalDateTime.now().format(DateTimeFormatter.ofPattern(dateFormat));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
</ol>
<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210924165637880.png" alt="image-20210924165637880">
      </p>

        <h3 id="热更新Nacos配置">
          <a href="#热更新Nacos配置" class="heading-link"><i class="fas fa-link"></i></a><a href="#热更新Nacos配置" class="headerlink" title="热更新Nacos配置"></a>热更新Nacos配置</h3>
      <blockquote>
<p>Nacos中的配置文件变更后，微服务无需重启就可以感知。不过需要下面两种配置实现：</p>
</blockquote>
<ul>
<li><p>方式一：在@Value注入的变量所在的类上打上<code>@RefreshScope</code>注解</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;pattern.dateformat&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String dateFormat;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;now&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getNow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> LocalDateTime.now().</span><br><span class="line">            format(DateTimeFormatter.ofPattern(dateFormat));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
<li><p>方式二：使用<code>@ConfigurationProperties</code>注解读取配置文件到配置类中，然后从配置类取得配置项的值</p>
<ol>
<li><p>读取到配置类中，并标记此配置类是一个Bean以方便其他地方注入使用</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;pattern&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PatternProperties</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String dateFormat;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
<li><p>注入配置类Bean并使用配置项的值</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> PatternProperties properties; <span class="comment">//注入配置类的Bean</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(&quot;now&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getNow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> LocalDateTime.now().</span><br><span class="line">        format(DateTimeFormatter.ofPattern(properties.getDateFormat()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p><strong>注意：这种方式不需要<code>@RefreshScope</code>注解</strong></p>
</li>
</ol>
</li>
</ul>
<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210924171537858.png" alt="image-20210924171537858">
      </p>

        <h3 id="多环境配置共享">
          <a href="#多环境配置共享" class="heading-link"><i class="fas fa-link"></i></a><a href="#多环境配置共享" class="headerlink" title="多环境配置共享"></a>多环境配置共享</h3>
      <blockquote>
<p>微服务在启动时会从Nacos读取多个配置文件</p>
<ul>
<li>[spring.application.name]-[spring.profiles.active].yaml，例如userservice-dev.yaml</li>
<li>[spring.application.name].yaml，例如userservice.yaml。这种情况下与环境无关</li>
</ul>
<p>无论环境如何变化，[spring.application.name]不会变化，所以[spring.application.name].yaml一定会加载</p>
</blockquote>
<ul>
<li><p>服务名.yaml可以被所有spring.application.name相同的服务读取到，属于共享配置</p>
</li>
<li><p>多种配置<strong>优先级</strong>：在本地application.yml、Nacos配置的某环境yaml、Nacos配置的通用共享yaml中：</p>
<p><strong>服务名-环境名.yaml &gt; 服务名.yaml &gt; 本地配置.yaml</strong>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210924174006951.png" alt="image-20210924174006951" style="zoom:50%;">
      </p>
</li>
</ul>

        <h2 id="Nacos集群">
          <a href="#Nacos集群" class="heading-link"><i class="fas fa-link"></i></a><a href="#Nacos集群" class="headerlink" title="Nacos集群"></a>Nacos集群</h2>
      
        <h3 id="1-Nacos集群结构图">
          <a href="#1-Nacos集群结构图" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-Nacos集群结构图" class="headerlink" title="1.Nacos集群结构图"></a>1.Nacos集群结构图</h3>
      
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210925001827900.png" alt="image-20210925001827900" style="zoom:50%;">
      


        <h3 id="2-搭建集群：步骤">
          <a href="#2-搭建集群：步骤" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-搭建集群：步骤" class="headerlink" title="2.搭建集群：步骤"></a>2.<strong>搭建集群</strong>：步骤</h3>
      <ul>
<li><p>搭建数据库集群，初始化数据库表结构</p>
<ul>
<li>Nacos默认数据存储在内嵌的Derby数据库中，不属于生产可用的数据库</li>
<li>官方推荐的最佳实践是使用带有主从的高可用数据库集群，主从模式的高可用数据库自学</li>
<li>这里以单点的数据库为例：<ol>
<li>新建一个数据库，命名为nacos</li>
<li>导入nacos建表有关SQL（注意字段为datetime类型赋默认值需要MySQL5.6版本以上）</li>
</ol>
</li>
</ul>
</li>
<li><p>下载nacos安装包</p>
</li>
<li><p>配置nacos</p>
<ul>
<li><p>配置nacos安装目录下的<code>conf</code>目录下的<code>cluster.conf</code>，设置集群的节点</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:8845</span><br><span class="line">127.0.0.1.8846</span><br><span class="line">127.0.0.1.8847</span><br></pre></td></tr></table></div></figure></li>
<li><p>配置nacos安装目录下的<code>conf</code>目录下的<code>application.properties</code>，配置数据库</p>
<figure class="highlight properties"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#*************** Config Module Related Configurations ***************#</span></span><br><span class="line"><span class="comment">### If use MySQL as datasource:</span></span><br><span class="line"><span class="meta">spring.datasource.platform</span>=<span class="string">mysql</span></span><br><span class="line"><span class="comment">### Count of DB:</span></span><br><span class="line"><span class="meta">db.num</span>=<span class="string">1</span></span><br><span class="line"><span class="comment">### Connect URL of DB:</span></span><br><span class="line"><span class="meta">db.url.0</span>=<span class="string">jdbc:mysql://127.0.0.1:3306/nacos?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useUnicode=true&amp;useSSL=false&amp;serverTimezone=UTC</span></span><br><span class="line"><span class="meta">db.user.0</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">db.password.0</span>=<span class="string">199988</span></span><br></pre></td></tr></table></div></figure></li>
<li><p>配置多个nacos服务器的端口（8845、8846、8847）</p>
<figure class="highlight properties"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### Default web server port:</span></span><br><span class="line"><span class="meta">server.port</span>=<span class="string">8845</span></span><br></pre></td></tr></table></div></figure>

<p><font color="red"><strong>JVM内存不够的问题！</strong></font></p>
<p>配置nacos安装目录下的<code>bin</code>目录下的启动脚本，修改<code>cluster</code>模式下的JVM参数</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">rem <span class="keyword">if</span> nacos startup mode is cluster</span><br><span class="line"><span class="keyword">if</span> %MODE% == <span class="string">&quot;cluster&quot;</span> (</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;nacos is starting with cluster&quot;</span></span><br><span class="line">	  <span class="keyword">if</span> %EMBEDDED_STORAGE% == <span class="string">&quot;embedded&quot;</span> (</span><br><span class="line">	      <span class="built_in">set</span> <span class="string">&quot;NACOS_OPTS=-DembeddedStorage=true&quot;</span></span><br><span class="line">	  )</span><br><span class="line">    <span class="built_in">set</span> <span class="string">&quot;NACOS_JVM_OPTS=-server -Xms512m -Xmx512m -Xmn256m 后面省略了</span></span><br><span class="line"><span class="string">)</span></span><br></pre></td></tr></table></div></figure></li>
</ul>
</li>
<li><p>启动nacos集群</p>
<ul>
<li>直接运行<code>startup.cmd</code>不需要再设置以单击启动的参数了</li>
</ul>
</li>
<li><p>配置nginx反向代理</p>
<ul>
<li><p>编辑nginx安装目录下的<code>conf</code>目录，在<code>http</code>标签内部加入nginx配置：</p>
<figure class="highlight nginx"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">upstream</span> nacos-cluster &#123;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8845</span>;</span><br><span class="line">	<span class="attribute">server</span> <span class="number">127.0.0.1:8846</span>;</span><br><span class="line">	<span class="attribute">server</span> <span class="number">127.0.0.1:8847</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  localhost;</span><br><span class="line">    <span class="attribute">location</span> /nacos &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://nacos-cluster;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
<li><p>启动nginx</p>
<ul>
<li>直接运行<code>start nginx.exe</code></li>
<li>停止nginx：<code>nginx.exe -s stop</code>或者<code>nginx.exe -s quit</code>，建议用quit优雅退出</li>
</ul>
</li>
<li><p>访问<code>http:localhost:80/nacos</code>即可代理到<code>nacos-cluster</code>所定义的几个负载均衡结点上</p>
</li>
</ul>
</li>
</ul>

        <h3 id="3-测试Nacos集群">
          <a href="#3-测试Nacos集群" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-测试Nacos集群" class="headerlink" title="3.测试Nacos集群"></a>3.测试Nacos集群</h3>
      <ul>
<li>访问<code>http:localhost:80/nacos</code>会被代理到负载均衡的节点上</li>
<li>在Nacos管理页面创建配置会保存到本地MySQL的<code>config_info</code>数据库中</li>
</ul>
<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210925012202746.png" alt="image-20210925012202746">
      </p>

        <h1 id="Feign远程调用">
          <a href="#Feign远程调用" class="heading-link"><i class="fas fa-link"></i></a><a href="#Feign远程调用" class="headerlink" title="Feign远程调用"></a>Feign远程调用</h1>
      
        <h2 id="RestTemplate方式调用存在的问题">
          <a href="#RestTemplate方式调用存在的问题" class="heading-link"><i class="fas fa-link"></i></a><a href="#RestTemplate方式调用存在的问题" class="headerlink" title="RestTemplate方式调用存在的问题"></a>RestTemplate方式调用存在的问题</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">User user = restTemplate.</span><br><span class="line">    getForObject(<span class="string">&quot;http://userservice/user/&quot;</span> + userId, User.class);</span><br></pre></td></tr></table></div></figure>

<ul>
<li>代码可读性差，编程体验不统一</li>
<li>参数复杂时URL难以维护</li>
</ul>

        <h2 id="Feign的概念">
          <a href="#Feign的概念" class="heading-link"><i class="fas fa-link"></i></a><a href="#Feign的概念" class="headerlink" title="Feign的概念"></a>Feign的概念</h2>
      <blockquote>
<p>Feign是一个声明式的http客户端，其作用就是帮助我们优雅的实现http请求的发送，解决以上的问题</p>
</blockquote>

        <h2 id="快速入门-2">
          <a href="#快速入门-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#快速入门-2" class="headerlink" title="快速入门"></a>快速入门</h2>
      <ol>
<li><p>引入起步依赖</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--Feign客户端--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></div></figure></li>
<li><p>在service的启动类上添加<code>@EnableFeignClients</code>注解开启Feign的功能</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderApplication</span> </span>&#123; ... &#125;</span><br></pre></td></tr></table></div></figure></li>
<li><p>编写Feign客户端的接口</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(&quot;userservice&quot;)</span> <span class="comment">//服务名称</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserClient</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/user/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function">User <span class="title">findById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>基于SpringMVC的注解来声明远程调用的信息，例如：</p>
<ul>
<li>服务名称：userservice</li>
<li>请求方式：GET</li>
<li>请求路径：/user/{id}</li>
<li>请求参数：Long id</li>
<li>返回值类型：User</li>
</ul>
</li>
<li><p>用Feign客户端代替RestTemplate</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> UserClient userClient; <span class="comment">//注入Feign客户端接口</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Order <span class="title">queryOrderById</span><span class="params">(Long orderId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1.查询订单</span></span><br><span class="line">    Order order = orderMapper.findById(orderId);</span><br><span class="line"><span class="comment">//      2.用Feign远程调用</span></span><br><span class="line">    User user = userClient.findById(order.getUserId());</span><br><span class="line"><span class="comment">//      3.封装数据</span></span><br><span class="line">    order.setUser(user);</span><br><span class="line">    <span class="comment">// 4.返回</span></span><br><span class="line">    <span class="keyword">return</span> order;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
</ol>
<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210925021404029.png" alt="image-20210925021404029">
      </p>

        <h2 id="自定义Feign的配置">
          <a href="#自定义Feign的配置" class="heading-link"><i class="fas fa-link"></i></a><a href="#自定义Feign的配置" class="headerlink" title="自定义Feign的配置"></a>自定义Feign的配置</h2>
      <blockquote>
<p>Feign运行自定义配置来覆盖默认配置，可以修改的配置如下：</p>
</blockquote>
<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210925022012411.png" alt="image-20210925022012411">
      </p>

        <h3 id="方式一：配置文件的方式">
          <a href="#方式一：配置文件的方式" class="heading-link"><i class="fas fa-link"></i></a><a href="#方式一：配置文件的方式" class="headerlink" title="方式一：配置文件的方式"></a>方式一：配置文件的方式</h3>
      <ul>
<li><p>全局生效</p>
<figure class="highlight yaml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">default:</span> <span class="comment">#对于所有的feign客户端生效</span></span><br><span class="line">        <span class="attr">loggerLevel:</span> <span class="string">FULL</span></span><br></pre></td></tr></table></div></figure></li>
<li><p>局部生效</p>
<figure class="highlight yaml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">userservice:</span> <span class="comment">#只对userservice的feign客户端生效</span></span><br><span class="line">        <span class="attr">loggerLevel:</span> <span class="string">FULL</span></span><br></pre></td></tr></table></div></figure></li>
</ul>

        <h3 id="方式二：Java代码的方式，需要声明一个Bean">
          <a href="#方式二：Java代码的方式，需要声明一个Bean" class="heading-link"><i class="fas fa-link"></i></a><a href="#方式二：Java代码的方式，需要声明一个Bean" class="headerlink" title="方式二：Java代码的方式，需要声明一个Bean"></a>方式二：Java代码的方式，需要声明一个Bean</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultFeignConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Logger.<span class="function">Level <span class="title">logLevel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//BASIC等级日志只记录请求方法和URL以及响应状态代码和执行时间。</span></span><br><span class="line">        <span class="keyword">return</span> Logger.Level.BASIC;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<ul>
<li><p>全局配置：把配置类的class放到启动类的<code>@EnableFeignClients</code>注解中</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients(defaultConfiguration = DefaultFeignConfiguration.class)</span></span><br></pre></td></tr></table></div></figure></li>
<li><p>局部配置：把配置类的class放到某个Feign客户端的<code>@FeignClient</code>注解中</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;userservice&quot;,configuration = DefaultFeignConfiguration.class)</span> </span><br></pre></td></tr></table></div></figure></li>
</ul>
<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210925023446855.png" alt="image-20210925023446855">
      </p>

        <h2 id="Feign的性能优化">
          <a href="#Feign的性能优化" class="heading-link"><i class="fas fa-link"></i></a><a href="#Feign的性能优化" class="headerlink" title="Feign的性能优化"></a>Feign的性能优化</h2>
      <ul>
<li>Feign底层的客户端实现：<ul>
<li>URLConnection：默认实现，不支持连接池</li>
<li>Apache HttpClient：支持连接池</li>
<li>OKHttp：支持连接池</li>
</ul>
</li>
<li>优化Feign的性能主要包括：<ul>
<li>使用连接池代替默认的URLConnection</li>
<li>日志级别最好用BASIC或NONE</li>
</ul>
</li>
</ul>
<p><strong>步骤：</strong></p>
<ol>
<li><p>引入HttpClient依赖</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--HttpClient--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></div></figure></li>
<li><p>配置连接池</p>
<figure class="highlight yaml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">httpclient:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment">#支持httpclient的开关</span></span><br><span class="line">    <span class="attr">max-connections:</span> <span class="number">200</span> <span class="comment">#最大连接数</span></span><br><span class="line">    <span class="attr">max-connections-per-route:</span> <span class="number">50</span> <span class="comment">#单个路径的最大连接数</span></span><br></pre></td></tr></table></div></figure></li>
</ol>
<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210925121436208.png" alt="image-20210925121436208">
      </p>

        <h2 id="Feign的最佳实践">
          <a href="#Feign的最佳实践" class="heading-link"><i class="fas fa-link"></i></a><a href="#Feign的最佳实践" class="headerlink" title="Feign的最佳实践"></a>Feign的最佳实践</h2>
      <p><strong>方式一（继承）：给消费者的FeignClient和提供者的Controller定义统一的父接口作为标准</strong></p>
<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210925122047188.png" alt="image-20210925122047188">
      </p>
<p><strong>方式二（抽取）：将FeignClient抽取为独立模块，并且把接口有关的POJO、默认的Feign配置都放到这个模块，提供给所有消费者使用</strong></p>
<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210925122506478.png" alt="image-20210925122506478">
      </p>
<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210925122544884.png" alt="image-20210925122544884">
      </p>
<p><strong>实现方式二（抽取FeignClient）：</strong></p>
<ol>
<li><p>新建一个module，命名为<code>feign-api</code>，然后引入feign的starter起步依赖</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></div></figure></li>
<li><p>将service中编写的FeignClient、POJO、DefaultFeignConfiguration复制到<code>feign-api</code>项目中</p>

        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210925125205808.png" alt="image-20210925125205808" style="zoom: 80%;">
       </li>
<li><p>在service中引入编写好的<code>feign-api</code>依赖</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--自己写的feign-api--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.itcast.demo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></div></figure></li>
<li><p>修改service中与上述三个组件相关的import部分，改为从<code>feign-api</code>依赖中引入</p>

        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210925125334508.png" alt="image-20210925125334508" style="zoom:67%;">
       </li>
</ol>
<ul>
<li><p><font color="red">此时启动service会导致引入的FeignClient客户端Bean无法被自动装载</font></p>
<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210925125513417.png" alt="image-20210925125513417">
      </p>
<p><strong>原因：</strong>引入的<code>feign-api</code>依赖下的FeignClient客户端位于<code>cn.itcast.feign.clients</code>包下，不属于当前service的@SpringBootApplication默认扫描包范围</p>
<p><strong>解决方法：</strong></p>
<ul>
<li><p>方式一：指定FeignClient所在包</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients(basePackages = &quot;cn.itcast.feign.clients&quot;)</span></span><br></pre></td></tr></table></div></figure></li>
<li><p>方式二：指定FeignClient的字节码</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients(clients = UserClient.class)</span></span><br></pre></td></tr></table></div></figure></li>
</ul>
</li>
</ul>
<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210925131403334.png" alt="image-20210925131403334">
      </p>

        <h1 id="Gateway服务网关">
          <a href="#Gateway服务网关" class="heading-link"><i class="fas fa-link"></i></a><a href="#Gateway服务网关" class="headerlink" title="Gateway服务网关"></a>Gateway服务网关</h1>
      
        <h2 id="网关的功能">
          <a href="#网关的功能" class="heading-link"><i class="fas fa-link"></i></a><a href="#网关的功能" class="headerlink" title="网关的功能"></a>网关的功能</h2>
      <p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210925131840527.png" alt="image-20210925131840527">
      </p>

        <h2 id="网关技术的实现">
          <a href="#网关技术的实现" class="heading-link"><i class="fas fa-link"></i></a><a href="#网关技术的实现" class="headerlink" title="网关技术的实现"></a>网关技术的实现</h2>
      <p>在SpringCloud中网关的实现包括两种：</p>
<ul>
<li>Gateway</li>
<li>Zuul</li>
</ul>
<blockquote>
<p>Zuul是基于Servlet的实现，属于阻塞式编程。而SpringCloud Gateway则是基于Spring5中提供的WebFlux，属于响应式编程的实现，具备更好的性能</p>
</blockquote>
<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210925132058849.png" alt="image-20210925132058849">
      </p>

        <h2 id="快速入门：搭建网关">
          <a href="#快速入门：搭建网关" class="heading-link"><i class="fas fa-link"></i></a><a href="#快速入门：搭建网关" class="headerlink" title="快速入门：搭建网关"></a>快速入门：搭建网关</h2>
      <ol>
<li><p>创建新的module，引入SpringCloud Gateway的依赖和Nacos依赖，创建网关的SpringBoot启动类</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--Nacos服务发现依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--网关依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></div></figure></li>
<li><p>编写路由配置以及nacos地址</p>
<figure class="highlight yaml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">10100</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="string">localhost:80</span> <span class="comment">#nacos地址</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">user-service</span> <span class="comment">#路由标识</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://userservice</span> <span class="comment">#路由的目标地址</span></span><br><span class="line">          <span class="attr">predicates:</span> <span class="comment">#断言，判断请求是否符合规则</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/user/**</span> <span class="comment">#断言是否是以/user/开头的请求</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">order-service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://orderservice</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/order/**</span></span><br></pre></td></tr></table></div></figure>

<p>启动访问<code>http://localhost:10100/user/&#123;id&#125;</code>或者<code>http://localhost:10100/order/&#123;orderId&#125;</code>即可</p>
<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210925133523283.png" alt="image-20210925133523283">
      </p>
</li>
</ol>
<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210925133647641.png" alt="image-20210925133647641">
      </p>

        <h2 id="路由断言工厂：Route-Predicate-Factory">
          <a href="#路由断言工厂：Route-Predicate-Factory" class="heading-link"><i class="fas fa-link"></i></a><a href="#路由断言工厂：Route-Predicate-Factory" class="headerlink" title="路由断言工厂：Route Predicate Factory"></a>路由断言工厂：Route Predicate Factory</h2>
      <p>网关路由可以配置的内容包括：</p>
<ul>
<li>路由id：路由的唯一标识</li>
<li>uri：路由目的地，支持lb（负载均衡）和http两种</li>
<li>predicates：路由断言，判断请求是否符合要求，符合则转发到路由目的地</li>
<li>filters：路由过滤器，处理请求或响应</li>
</ul>
<p>我们再配置文件中写的断言规则只是字符串，这些字符串会被Predicate Factory读取并处理，转为路由判断条件</p>
<p>例如：Path=/user/**是按照路径匹配，这个规则是由类：<code>org.springframework.cloud.gateway.handler.predicate.PathRoutePredicateFactory</code>处理</p>
<p>像这样的断言工厂还有：</p>
<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210925134110998.png" alt="image-20210925134110998">
      </p>
<p>组合断言：使用多个断言，如果不满足其中一个那么无法路由（404）</p>
<figure class="highlight yaml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="string">localhost:80</span> <span class="comment">#nacos地址</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">order-service</span> <span class="comment">#路由的目标地址</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://orderservice</span></span><br><span class="line">          <span class="attr">predicates:</span> <span class="comment">#断言，判断请求是否符合规则</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/order/**</span> <span class="comment">#断言是否是以/order/开头的请求</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Method=GET</span> <span class="comment">#请求方式必须为GET</span></span><br></pre></td></tr></table></div></figure>

<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210925135753346.png" alt="image-20210925135753346">
      </p>

        <h2 id="路由过滤器：GatewayFilter">
          <a href="#路由过滤器：GatewayFilter" class="heading-link"><i class="fas fa-link"></i></a><a href="#路由过滤器：GatewayFilter" class="headerlink" title="路由过滤器：GatewayFilter"></a>路由过滤器：GatewayFilter</h2>
      <blockquote>
<p>GatewayFilter是网关中提供的一种过滤器，可以对进入网关的请求和微服务返回的响应做处理</p>
</blockquote>
<p><strong>过滤器工厂GatewayFilterFacotry</strong></p>
<p>Spring提供了31种不同的路由过滤器工厂：</p>

        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210925140135506.png" alt="image-20210925140135506" style="zoom: 50%;">
       

<p>案例：给所有进入userservice的请求添加一个请求头：TAOYYZ=likeccz</p>
<p>实现方式：在gateway的SpringBoot核心配置文件中给userservice的路由添加过滤器</p>
<figure class="highlight yaml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="string">localhost:80</span> <span class="comment">#nacos地址</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">user-service</span> <span class="comment">#路由标识</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://userservice</span> <span class="comment">#路由的目标地址</span></span><br><span class="line">          <span class="attr">predicates:</span> <span class="comment">#断言，判断请求是否符合规则</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/user/**</span> <span class="comment">#断言是否是以/user/开头的请求</span></span><br><span class="line">          <span class="attr">filters:</span> <span class="comment">#过滤器</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">AddRequestHeader=TAOYYZ,likeccz</span> <span class="comment">#加入请求头</span></span><br></pre></td></tr></table></div></figure>

<p><strong>默认过滤器：</strong>如果要对所有的路由都生效此过滤器，则可以将过滤器工厂写到<code>default-filters</code>下：</p>
<figure class="highlight yaml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="string">localhost:80</span> <span class="comment">#nacos地址</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">user-service</span> <span class="comment">#路由标识</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://userservice</span> <span class="comment">#路由的目标地址</span></span><br><span class="line">          <span class="attr">predicates:</span> <span class="comment">#断言，判断请求是否符合规则</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/user/**</span> <span class="comment">#断言是否是以/user/开头的请求</span></span><br><span class="line">      <span class="attr">default-filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">AddRequestHeader=TAOYYZ,likeccz</span> <span class="comment">#对所有请求都加入请求头</span></span><br></pre></td></tr></table></div></figure>


        <h2 id="全局过滤器：GlobalFilter">
          <a href="#全局过滤器：GlobalFilter" class="heading-link"><i class="fas fa-link"></i></a><a href="#全局过滤器：GlobalFilter" class="headerlink" title="全局过滤器：GlobalFilter"></a>全局过滤器：GlobalFilter</h2>
      <blockquote>
<p>全局过滤器的作用也是处理一切进入网关的请求和微服务响应，与GatewayFilter的作用一样</p>
<p>区别在于GatewayFilter通过配置定义，处理逻辑是固定的。而GlobalFilter的逻辑需要自己写代码实现</p>
</blockquote>
<p>定义方式：实现GlobalFilter接口</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GlobalFilter</span> </span>&#123;</span><br><span class="line">	<span class="function">Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>案例：定义全局过滤器，拦截并判断用户身份</p>
<p>需求：定义全局过滤器，判断请求参数是否满足以下条件</p>
<ul>
<li>参数中有lover</li>
<li>lover参数值为ccz</li>
</ul>
<p>如果满足则放行，否则拦截</p>
<p>实现：定义一个全局过滤器的实现类，实现<code>filter()</code>方法，并且指定为Spring组件，并定义Order执行顺序</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span> <span class="comment">//标记为Spring的Bean</span></span><br><span class="line"><span class="comment">//@Order(-1) //设置执行顺序，也可以实现Ordered接口的getOrder()方法返回一个int值</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoverFilter</span> <span class="keyword">implements</span> <span class="title">GlobalFilter</span>, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//1.获取请求参数</span></span><br><span class="line">        ServerHttpRequest request = exchange.getRequest();</span><br><span class="line">        <span class="comment">//2.获取请求参数中的lover参数</span></span><br><span class="line">        MultiValueMap&lt;String, String&gt; queryParams = request.getQueryParams();</span><br><span class="line">        <span class="comment">//3.判断参数值是否为ccz</span></span><br><span class="line">        String lover = queryParams.getFirst(<span class="string">&quot;lover&quot;</span>);</span><br><span class="line">        <span class="comment">//4.是的话放行</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;ccz&quot;</span>.equals(lover)) &#123;</span><br><span class="line">            <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//5.否则拦截</span></span><br><span class="line">        <span class="comment">//5.1为了给用户一个提示，设置一个响应状态码</span></span><br><span class="line">        exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);</span><br><span class="line">        <span class="keyword">return</span> exchange.getResponse().setComplete();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>此时访问<code>http://localhost:10100/order/101</code>会被拦截并返回401状态码，因为参数没有<code>lover=ccz</code></p>
<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210925143511913.png" alt="image-20210925143511913">
      </p>

        <h2 id="过滤器执行顺序">
          <a href="#过滤器执行顺序" class="heading-link"><i class="fas fa-link"></i></a><a href="#过滤器执行顺序" class="headerlink" title="过滤器执行顺序"></a>过滤器执行顺序</h2>
      <p>请求进入网关会碰到三类过滤器：当前路由的过滤器、DefaultFilter、GlobalFilter</p>
<p>请求路由后，会将当前路由过滤器和DefaultFilter、GlobalFilter合并到一个过滤器链中，<strong>排序</strong>后依次执行每个过滤器</p>
<ul>
<li>当前路由过滤器和<code>DefaultFilter</code>都属于<code>GatewayFilter</code></li>
<li><code>GlobalFilter</code>通过<code>GatewayFilterAdapter</code>适配成<code>GatewayFilter</code></li>
</ul>
<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210925145341333.png" alt="image-20210925145341333">
      </p>
<p><strong>排序：</strong></p>
<ul>
<li>每一个过滤器都必须指定一个int类型的Order值，Order值越小，优先级越高，执行顺序越靠前</li>
<li>GlobalFilter通过实现Ordered接口或@Order注解来指定Order值，由我们自己指定</li>
<li>路由过滤器和DefaultFilter的Order值由Spring指定，默认是按照声明顺序从1开始递增</li>
<li>当过滤器的Order值一样时：<strong>DefaultFilter &gt; 路由过滤器 &gt; GlobalFilter</strong></li>
</ul>
<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210925150025819.png" alt="image-20210925150025819">
      </p>
<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210925150035328.png" alt="image-20210925150035328">
      </p>

        <h2 id="跨域问题处理">
          <a href="#跨域问题处理" class="heading-link"><i class="fas fa-link"></i></a><a href="#跨域问题处理" class="headerlink" title="跨域问题处理"></a>跨域问题处理</h2>
      <p>跨域是域名不一致，主要包括：</p>
<ul>
<li>域名不同：<code>www.taobao.com</code>和<code>www.taobao.org</code></li>
<li>域名相同，端口不同：<code>localhost:8081</code>和<code>localhost:8081</code></li>
</ul>
<p><strong>跨域问题</strong>：<strong>浏览器禁止</strong>请求的发起者与服务器端发生跨域的<strong>AJAX请求</strong>，请求被浏览器拦截的问题</p>
<p>解决方案：CORS</p>
<p>网关处理跨域采用的是CORS方案，只需要简单配置即可实现：</p>
<figure class="highlight yaml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">globalcors:</span> <span class="comment"># 全局的跨域处理</span></span><br><span class="line">        <span class="attr">add-to-simple-url-handler-mapping:</span> <span class="literal">true</span> <span class="comment"># 解决options请求被拦截问题</span></span><br><span class="line">        <span class="attr">corsConfigurations:</span></span><br><span class="line">          <span class="string">&#x27;[/**]&#x27;</span><span class="string">:</span></span><br><span class="line">            <span class="attr">allowedOrigins:</span> <span class="comment"># 允许哪些网站的跨域请求</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&quot;http://localhost:8090&quot;</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&quot;http://www.leyou.com&quot;</span></span><br><span class="line">            <span class="attr">allowedMethods:</span> <span class="comment"># 允许的跨域ajax的请求方式</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&quot;GET&quot;</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&quot;POST&quot;</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&quot;DELETE&quot;</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&quot;PUT&quot;</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&quot;OPTIONS&quot;</span></span><br><span class="line">            <span class="attr">allowedHeaders:</span> <span class="string">&quot;*&quot;</span> <span class="comment"># 允许在请求中携带的头信息</span></span><br><span class="line">            <span class="attr">allowCredentials:</span> <span class="literal">true</span> <span class="comment"># 是否允许携带cookie</span></span><br><span class="line">            <span class="attr">maxAge:</span> <span class="number">360000</span> <span class="comment"># 这次跨域检测的有效期</span></span><br></pre></td></tr></table></div></figure>

<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210925152048065.png" alt="image-20210925152048065">
      </p>

        <h1 id="RabbitMQ消息队列">
          <a href="#RabbitMQ消息队列" class="heading-link"><i class="fas fa-link"></i></a><a href="#RabbitMQ消息队列" class="headerlink" title="RabbitMQ消息队列"></a>RabbitMQ消息队列</h1>
      
        <h2 id="同步和异步">
          <a href="#同步和异步" class="heading-link"><i class="fas fa-link"></i></a><a href="#同步和异步" class="headerlink" title="同步和异步"></a>同步和异步</h2>
      
        <h3 id="同步调用存在的问题">
          <a href="#同步调用存在的问题" class="heading-link"><i class="fas fa-link"></i></a><a href="#同步调用存在的问题" class="headerlink" title="同步调用存在的问题"></a>同步调用存在的问题</h3>
      <p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210929010842471.png" alt="image-20210929010842471">
      </p>

        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210929010920818.png" alt="image-20210929010920818" style="zoom:50%;">
       


        <h3 id="异步调用方案">
          <a href="#异步调用方案" class="heading-link"><i class="fas fa-link"></i></a><a href="#异步调用方案" class="headerlink" title="异步调用方案"></a>异步调用方案</h3>
      <p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210929011140311.png" alt="image-20210929011140311">
      </p>

        <h3 id="事件驱动优势">
          <a href="#事件驱动优势" class="heading-link"><i class="fas fa-link"></i></a><a href="#事件驱动优势" class="headerlink" title="事件驱动优势"></a>事件驱动优势</h3>
      <ul>
<li><p>服务解耦</p>
</li>
<li><p>性能提升，吞吐量提高</p>
</li>
<li><p>服务没有强依赖，不担心级联失败问题</p>
</li>
<li><p>流量削峰
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210929011726020.png" alt="image-20210929011726020" style="zoom:50%;">
      </p>
</li>
</ul>
<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210929011911137.png" alt="image-20210929011911137">
      </p>

        <h2 id="常用的消息队列">
          <a href="#常用的消息队列" class="heading-link"><i class="fas fa-link"></i></a><a href="#常用的消息队列" class="headerlink" title="常用的消息队列"></a>常用的消息队列</h2>
      <blockquote>
<p>MQ（MessageQueue）消息队列，字面上来看就是存放消息的队列。也就是事件驱动架构中的Broker</p>
</blockquote>
<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210929012919073.png" alt="image-20210929012919073">
      </p>

        <h2 id="RabbitMQ">
          <a href="#RabbitMQ" class="heading-link"><i class="fas fa-link"></i></a><a href="#RabbitMQ" class="headerlink" title="RabbitMQ"></a>RabbitMQ</h2>
      <blockquote>
<p>RabbitMQ是基于Erlang语言开发的开源消息通信中间件</p>
</blockquote>

        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210930172348642.png" alt="image-20210930172348642" style="zoom: 67%;">
       

<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210930172431626.png" alt="image-20210930172431626">
      </p>

        <h2 id="安装RabbitMQ">
          <a href="#安装RabbitMQ" class="heading-link"><i class="fas fa-link"></i></a><a href="#安装RabbitMQ" class="headerlink" title="安装RabbitMQ"></a>安装RabbitMQ</h2>
      <ul>
<li><p>单机部署：</p>
<ol>
<li><p>加载RabbitMQ镜像到docker：</p>
<ul>
<li>在线拉取：<code>docker pull rabbitmq:3-management</code></li>
<li>从本地加载镜像的tar包：<code>docker load -i mq.tar</code></li>
</ul>
</li>
<li><p>运行RabbitMQ到容器：</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker run \</span><br><span class="line"> -e RABBITMQ_DEFAULT_USER=account \</span><br><span class="line"> -e RABBITMQ_DEFAULT_PASS=password \</span><br><span class="line"> --name mq \</span><br><span class="line"> --hostname mq1 \</span><br><span class="line"> -p 15672:15672 \</span><br><span class="line"> -p 5672:5672 \</span><br><span class="line"> -d \</span><br><span class="line"> rabbitmq:3-management</span><br></pre></td></tr></table></div></figure></li>
</ol>
</li>
</ul>

        <h2 id="常见消息模型">
          <a href="#常见消息模型" class="heading-link"><i class="fas fa-link"></i></a><a href="#常见消息模型" class="headerlink" title="常见消息模型"></a>常见消息模型</h2>
      
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210930172958391.png" alt="image-20210930172958391" style="zoom: 50%;">
       


        <h3 id="1-HelloWorld案例——简单队列模型">
          <a href="#1-HelloWorld案例——简单队列模型" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-HelloWorld案例——简单队列模型" class="headerlink" title="1. HelloWorld案例——简单队列模型"></a>1. HelloWorld案例——简单队列模型</h3>
      <p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210930173119852.png" alt="image-20210930173119852">
      </p>
<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210930175724961.png" alt="image-20210930175724961">
      </p>

        <h2 id="SpringAMQP">
          <a href="#SpringAMQP" class="heading-link"><i class="fas fa-link"></i></a><a href="#SpringAMQP" class="headerlink" title="SpringAMQP"></a>SpringAMQP</h2>
      
        <h3 id="概念-1">
          <a href="#概念-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#概念-1" class="headerlink" title="概念"></a>概念</h3>
      <p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210930180247019.png" alt="image-20210930180247019">
      </p>

        <h3 id="快速入门-3">
          <a href="#快速入门-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#快速入门-3" class="headerlink" title="快速入门"></a>快速入门</h3>
      <p><strong>案例：</strong>利用SpringAMQP实现HelloWorld中的简单队列模型的基础消息队列功能</p>
<ol>
<li><p>在父工程中引入spring-amqp的<strong>起步依赖</strong></p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--AMQP依赖，包含RabbitMQ--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></div></figure></li>
<li><p>在publisher服务中利用RabbitTemplate<strong>发送消息</strong>到simple.queue这个队列</p>
<ul>
<li><p>在publisher服务的SpringBoot核心配置文件中配置mq连接信息：</p>
<figure class="highlight yaml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.220</span><span class="number">.12</span> <span class="comment">#RabbitMQ主机，默认localhost</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span> <span class="comment">#端口，默认为5672，如果启用SSL，则为5671</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span> <span class="comment">#虚拟主机</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">itcast</span> <span class="comment">#默认guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">12345</span> <span class="comment">#默认guest</span></span><br></pre></td></tr></table></div></figure></li>
<li><p>在publisher服务中新建一个类来测试方法</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringAmqpTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String queueName = <span class="string">&quot;simple.queue&quot;</span>;</span><br><span class="line">        String message = <span class="string">&quot;hello springAmqp by taoyyz2&quot;</span>;</span><br><span class="line">        rabbitTemplate.convertAndSend(queueName,message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
</ul>
</li>
<li><p>在consumer服务中编写<strong>消费</strong>逻辑，绑定simple.queue这个队列</p>
<ul>
<li><p>在consumer服务的SpringBoot核心配置文件中配置mq连接信息：</p>
<figure class="highlight yaml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.220</span><span class="number">.12</span> <span class="comment">#RabbitMQ主机，默认localhost</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span> <span class="comment">#端口，默认为5672，如果启用SSL，则为5671</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span> <span class="comment">#虚拟主机</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">itcast</span> <span class="comment">#默认guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">12345</span> <span class="comment">#默认guest</span></span><br></pre></td></tr></table></div></figure></li>
<li><p>在consumer服务中新建一个消息监听器类（注册为Bean），编写消费逻辑：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringAmqpListenerTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RabbitListener(queues = &quot;simple.queue&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listenSimpleQueueMessage</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;接受到的消息：&quot;</span> + msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
</ul>
</li>
</ol>

        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210930210805550.png" alt="image-20210930210805550" style="zoom: 50%;">
        


        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210930220240837.png" alt="image-20210930220240837" style="zoom: 50%;">
       


        <h3 id="2-Work-Queue工作队列">
          <a href="#2-Work-Queue工作队列" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-Work-Queue工作队列" class="headerlink" title="2. Work Queue工作队列"></a>2. Work Queue工作队列</h3>
      <blockquote>
<p>工作队列可以提高消息处理速度，避免队列消息堆积</p>
</blockquote>

        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210930220634785.png" alt="image-20210930220634785" style="zoom:50%;">
      

<p><strong>案例：</strong>模拟Work Queue，实现一个队列绑定多个消费者</p>
<p>思路：</p>
<ul>
<li><p>在publisher服务中定义测试方法，每秒产生50条消息，发送到simple.queue</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    String queueName = <span class="string">&quot;simple.queue&quot;</span>;</span><br><span class="line">    String message = <span class="string">&quot;hello springAmqp__&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">50</span>; i++) &#123;</span><br><span class="line">        rabbitTemplate.convertAndSend(queueName, message + i + <span class="string">&quot;   &quot;</span>);</span><br><span class="line">        Thread.sleep(<span class="number">20</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;推送消息完成&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
<li><p>在consumer服务中定义两个消息监听者，都监听simple.queue队列</p>
</li>
<li><p>消费者1每秒处理50条消息，消费者2每秒处理10条消息</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = &quot;simple.queue&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listenSimpleQueueMessage</span><span class="params">(String msg)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;【1】接受到的消息是：&quot;</span> + msg + LocalTime.now());</span><br><span class="line">    Thread.sleep(<span class="number">20</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(queues = &quot;simple.queue&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listenSimpleQueueMessage2</span><span class="params">(String msg)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    System.err.println(<span class="string">&quot;【2】接受到的消息是：&quot;</span> + msg + LocalTime.now());</span><br><span class="line">    Thread.sleep(<span class="number">100</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
</ul>
<p><font color="red"><strong>问题</strong>：</font>由于消费者2处理能力差，在获取消息时与消费者1都分别<strong>预取</strong>了25条消息，导致消费者2消费25条消息需要大量的时间</p>

        <h3 id="消费预取限制">
          <a href="#消费预取限制" class="heading-link"><i class="fas fa-link"></i></a><a href="#消费预取限制" class="headerlink" title="消费预取限制"></a>消费预取限制</h3>
      <p>修改SpringBoot核心配置文件，设置preFetch值，可以控制预取消息的上限：</p>
<figure class="highlight yaml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">prefetch:</span> <span class="number">1</span> <span class="comment">#每个消费者可以未确认的最大未确认消息数。</span></span><br></pre></td></tr></table></div></figure>

<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20210930233018894.png" alt="image-20210930233018894">
      </p>

        <h3 id="发布（Publish）、订阅（Subscribe）">
          <a href="#发布（Publish）、订阅（Subscribe）" class="heading-link"><i class="fas fa-link"></i></a><a href="#发布（Publish）、订阅（Subscribe）" class="headerlink" title="发布（Publish）、订阅（Subscribe）"></a>发布（Publish）、订阅（Subscribe）</h3>
      <blockquote>
<p>发布订阅模式与之前的区别就是允许将同一消息发送给多个消费者，实现方式是加入了exchange（交换机）</p>
</blockquote>
<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20211001003507962.png" alt="image-20211001003507962">
      </p>

        <h4 id="3-FanoutExchange">
          <a href="#3-FanoutExchange" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-FanoutExchange" class="headerlink" title="3. FanoutExchange"></a>3. FanoutExchange</h4>
      <blockquote>
<p>Fanout Exchange会将接受到的消息路由到每一个跟其绑定的queue，称为广播模式</p>
</blockquote>
<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20211001003712624.png" alt="image-20211001003712624">
      </p>
<p><strong>案例：</strong>利用SpringAMQP演示FanoutExchange的使用</p>
<p>思路：
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20211001004124505.png" alt="image-20211001004124505">
      </p>
<ul>
<li><p>在consumer服务中，利用代码声明队列、交换机，并将两者绑定</p>
<ul>
<li><p>在consumer服务中声明Exchange、Queue、Binding</p>
<p>SpringAMQP提供了声明交换机、队列、绑定关系的API，例如：</p>

        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20211001004924838.png" alt="image-20211001004924838" style="zoom:75%;">
      </li>
<li><p>在consumer服务中编写一个配置类，用于产生FanoutExchange、Queue和绑定关系对象Binding</p>
</li>
</ul>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FanoutConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FanoutExchange <span class="title">fanoutExchange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//产生交换机Bean</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FanoutExchange(<span class="string">&quot;test.fanout&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">fanoutQueue1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//产生第一个队列的Bean</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Queue(<span class="string">&quot;fanout.q1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">fanoutQueue2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//产生第二个队列的Bean</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Queue(<span class="string">&quot;fanout.q2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Binding <span class="title">fanoutBinding1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//绑定队列1到交换机，这里可以通过调方法的返回值获取队列和交换机</span></span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(fanoutQueue1()).to(fanoutExchange());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Binding <span class="title">fanoutBinding2</span><span class="params">(Queue fanoutQueue2,FanoutExchange fanoutExchange)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//绑定队列2到交换机，这里通过参数注入这俩Bean</span></span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(fanoutQueue2).to(fanoutExchange);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
<li><p>在consumer服务中，编写两个消费者方法，分别监听fanout.queue1和fanout.queue2</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = &quot;fanout.q1&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listenSimpleQueueMessage3</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;【queue1】接受到的消息是：&quot;</span> + msg + LocalTime.now());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(queues = &quot;fanout.q2&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listenSimpleQueueMessage4</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">    System.err.println(<span class="string">&quot;【queue2】接受到的消息是：&quot;</span> + msg + LocalTime.now());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
<li><p>在publisher中编写测试方法，向交换机发送消息</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSendFanoutExchange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//交换机名称</span></span><br><span class="line">    String exchangeName = <span class="string">&quot;test.fanout&quot;</span>;</span><br><span class="line">    <span class="comment">//消息</span></span><br><span class="line">    String msg = <span class="string">&quot;hello,everyOne!&quot;</span>;</span><br><span class="line">    <span class="comment">//发送消息</span></span><br><span class="line">    rabbitTemplate.convertAndSend(exchangeName,<span class="string">&quot;&quot;</span>, msg);</span><br><span class="line">    System.out.println(<span class="string">&quot;发送完成！&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p><strong><font color="red">踩坑！！！交换机无法接收到publisher中推送的消息，消费者也无法订阅到消息</font></strong></p>
<p><strong>原因：</strong>RabbitTemplate对象的<code>convertAndSend()</code>方法选择了错误的重载：
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20211001154451836.png" alt="image-20211001154451836">
      </p>
</li>
</ul>
<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20211001164327103.png" alt="image-20211001164327103">
      </p>

        <h4 id="4-DirectExchange">
          <a href="#4-DirectExchange" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-DirectExchange" class="headerlink" title="4. DirectExchange"></a>4. DirectExchange</h4>
      <blockquote>
<p>Direct Exchange会将接受到的消息根据规则路由到指定的Queue，称为路由模式（routes）</p>
</blockquote>
<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20211001165453866.png" alt="image-20211001165453866">
      </p>
<p><strong>案例：</strong>利用SpringAMQP演示DirectExchange的使用</p>

        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20211001165830038.png" alt="image-20211001165830038" style="zoom: 60%;">
       

<p>思路：</p>
<ul>
<li><p>利用@RabbitListener声明Exchange、Queue、routingKey，<em>代码同下一步</em></p>
</li>
<li><p>在consumer服务中，编写两个消费者方法，分别监听direct.queue1和direct.queue2</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">        value = @Queue(name = &quot;direct.q1&quot;), //绑定的队列名</span></span><br><span class="line"><span class="meta">        exchange = @Exchange(name = &quot;itcast.direct&quot;, type = ExchangeTypes.DIRECT),//默认为direct</span></span><br><span class="line"><span class="meta">        key = &#123;&quot;red&quot;, &quot;blue&quot;&#125; //routingKey路由键</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listenDirectQueue1</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;【queue1】接受到的消息是：&quot;</span> + msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">        value = @Queue(name = &quot;direct.q2&quot;), //绑定的队列名</span></span><br><span class="line"><span class="meta">        exchange = @Exchange(name = &quot;itcast.direct&quot;, type = ExchangeTypes.DIRECT),//默认为direct</span></span><br><span class="line"><span class="meta">        key = &#123;&quot;red&quot;, &quot;yellow&quot;&#125; //routingKey路由键</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listenDirectQueue2</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;【queue2】接受到的消息是：&quot;</span> + msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
<li><p>在publisher中编写测试方法，向itcast.direct发送消息</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSendDirectExchange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String exchangeName = <span class="string">&quot;itcast.direct&quot;</span>;</span><br><span class="line">    String msg = <span class="string">&quot;hello direct!!&quot;</span>;</span><br><span class="line">    rabbitTemplate.convertAndSend(exchangeName, <span class="string">&quot;red&quot;</span>, msg); <span class="comment">//监听了red的routingKey的队列均可收到</span></span><br><span class="line">    System.out.println(<span class="string">&quot;发送完成！&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20211001171259343.png" alt="image-20211001171259343">
      </p>
</li>
</ul>

        <h4 id="5-TopicExchange">
          <a href="#5-TopicExchange" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-TopicExchange" class="headerlink" title="5. TopicExchange"></a>5. TopicExchange</h4>
      <blockquote>
<p>TopicExchange的routingKey必须是多个单词的列表，并且以<code>.</code>分隔</p>
<p>Queue与Exchange指定BindingKey时可以使用通配符：</p>
<p><code>#</code>：代表0个或多个单词</p>
<p><code>*</code>：代表一个单词</p>
</blockquote>
<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20211001180909842.png" alt="image-20211001180909842">
      </p>
<p><strong>案例：</strong>利用SpringAMQP演示TopicExchange的使用</p>

        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20211001181140583.png" alt="image-20211001181140583" style="zoom:67%;">
      

<p>思路：</p>
<ul>
<li><p>利用@RabbitListener声明Exchange、Queue、routingKey，<em>代码同下一步</em></p>
</li>
<li><p>在consumer服务中，编写两个消费者方法，分别监听topic.queue1和topic.queue2</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">        value = @Queue(name = &quot;topic.q1&quot;),</span></span><br><span class="line"><span class="meta">        exchange = @Exchange(name = &quot;itcast.topic&quot;, type = ExchangeTypes.TOPIC),</span></span><br><span class="line"><span class="meta">        key = &quot;china.#&quot;</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listenTopicQueue1</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;【topic.q1】接受到的消息是：&quot;</span> + msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">        value = @Queue(name = &quot;topic.q2&quot;),</span></span><br><span class="line"><span class="meta">        exchange = @Exchange(name = &quot;itcast.topic&quot;, type = ExchangeTypes.TOPIC),</span></span><br><span class="line"><span class="meta">        key = &quot;#.news&quot;</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listenTopicQueue2</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;【topic.q2】接受到的消息是：&quot;</span> + msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
<li><p>在publisher中编写测试方法，向itcast.topic发送消息</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSendTopicExchange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String exchangeName = <span class="string">&quot;itcast.topic&quot;</span>;</span><br><span class="line">    String msg = <span class="string">&quot;hello topic china!!&quot;</span>;</span><br><span class="line">    <span class="comment">// china.# 和 #.news都能收到</span></span><br><span class="line">    rabbitTemplate.convertAndSend(exchangeName, <span class="string">&quot;china.news&quot;</span>, msg);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// china.# 能收到</span></span><br><span class="line">    rabbitTemplate.convertAndSend(exchangeName, <span class="string">&quot;china.whether&quot;</span>, msg);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// #.news 能收到</span></span><br><span class="line">    rabbitTemplate.convertAndSend(exchangeName, <span class="string">&quot;japan.news&quot;</span>, msg);</span><br><span class="line">    System.out.println(<span class="string">&quot;发送完成！&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
</ul>

        <h3 id="消息转换器">
          <a href="#消息转换器" class="heading-link"><i class="fas fa-link"></i></a><a href="#消息转换器" class="headerlink" title="消息转换器"></a>消息转换器</h3>
      <blockquote>
<p>在SpringAMQP的发送方法中，消息的类型是Object，也就是说可以发送任意对象的消息，SpringAMQP会序列化为字节后发送</p>
</blockquote>
<p>Spring对消息对象的处理是由<code>org.springframework.amqp.support.converter.MessageConverter</code>来处理的</p>
<p>而默认实现是SimpleMessageConverter，基于JDK的ObjectOutputStream完成序列化。这种方式性能较差。</p>
<p>自定义MessageConverter的Bean即可，<strong>推荐使用json序列化：</strong></p>
<ul>
<li><p>发送消息：</p>
<ol>
<li><p>在publisher服务中引入jackson依赖：</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--jackson依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></div></figure></li>
<li><p>在publisher服务中声明MessageConverter的Bean，使得发送消息时可以以JSON格式发送</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> MessageConverter <span class="title">messageConverter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Jackson2JsonMessageConverter();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
<li><p>在publisher服务中发送消息：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSendObject</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Map&lt;String, Object&gt; msg = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    msg.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;菜菜子&quot;</span>);</span><br><span class="line">    msg.put(<span class="string">&quot;age&quot;</span>, <span class="number">21</span>);</span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;object.queue&quot;</span>,msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
</ol>
</li>
<li><p>接收消息：</p>
<ol>
<li><p>在consumer服务中也引入jackson依赖</p>
</li>
<li><p>在consumer服务中声明MessageConverter的Bean，使得接受消息时可以以JSON格式解析</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> MessageConverter <span class="title">messageConverter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Jackson2JsonMessageConverter();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
<li><p>在consumer服务中定义一个监听者监听队列接收消息</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = &quot;object.queue&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listenObjectQueue</span><span class="params">(Map&lt;String, Object&gt; msg)</span> </span>&#123;</span><br><span class="line">    msg.forEach((s, o) -&gt; System.out.println(s + <span class="string">&quot; --&gt; &quot;</span> + o));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
</ol>
</li>
</ul>
<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="/images/image-20211001214355743.png" alt="image-20211001214355743">
      </p>
</div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ 本文结束，感谢您的阅读 ------</div></div><div class="post-tags"><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="http://taoyyz.github.io/tags/Java/">Java</a></span><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="http://taoyyz.github.io/tags/Spring/">Spring</a></span></div><console class="log" 123></console><div class="post-reward reward"><div class="reward-button">看的开心的话可以请我喝杯奶茶~热狗也行呜呜呜</div><div class="reward-qrcode"><span class="reward-qrcode-alipay"><img class="reward-qrcode-alipay__img" src="/images/zfb.jpg"><div class="reward-qrcode-alipay__text">支付宝</div></span><span class="reward-qrcode-wechat"><img class="reward-qrcode-wechat__img" src="/images/vx.jpg"><div class="reward-qrcode-wechat__text">微信</div></span></div></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/2022/08/14/Mac%E6%8A%80%E5%B7%A7/"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">Mac使用技巧</span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/2021/09/01/MyBatis/"><span class="paginator-prev__text">Mybatis基础</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">文章目录</span><span class="sidebar-nav-ov">站点概览</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AF%BC%E5%AD%A6"><span class="toc-number">1.</span> <span class="toc-text">
          导学</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5"><span class="toc-number">2.</span> <span class="toc-text">
          概念</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84"><span class="toc-number">2.1.</span> <span class="toc-text">
          架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A"><span class="toc-number">2.2.</span> <span class="toc-text">
          微服务：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BB%93%E6%9E%84"><span class="toc-number">2.3.</span> <span class="toc-text">
          微服务结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringCloud"><span class="toc-number">2.4.</span> <span class="toc-text">
          SpringCloud</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%8B%86%E5%88%86"><span class="toc-number">2.5.</span> <span class="toc-text">
          服务拆分</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8"><span class="toc-number">2.6.</span> <span class="toc-text">
          微服务远程调用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Eureka%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="toc-number">3.</span> <span class="toc-text">
          Eureka注册中心</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%90%E4%BE%9B%E8%80%85%E4%B8%8E%E6%B6%88%E8%B4%B9%E8%80%85"><span class="toc-number">3.1.</span> <span class="toc-text">
          提供者与消费者</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Eureka%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">3.2.</span> <span class="toc-text">
          Eureka的作用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8%E5%87%BA%E7%8E%B0%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">3.3.</span> <span class="toc-text">
          服务调用出现的问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="toc-number">3.4.</span> <span class="toc-text">
          快速入门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%90%AD%E5%BB%BAEurekaServer%E6%9C%8D%E5%8A%A1"><span class="toc-number">3.4.1.</span> <span class="toc-text">
          1.搭建EurekaServer服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%B3%A8%E5%86%8Cservice%E5%88%B0EurekaServer%EF%BC%88%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%EF%BC%89"><span class="toc-number">3.4.2.</span> <span class="toc-text">
          2.注册service到EurekaServer（服务注册）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%8B%89%E5%8F%96service%E4%BB%8EEurekaServer%EF%BC%88%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%EF%BC%89"><span class="toc-number">3.4.3.</span> <span class="toc-text">
          3.拉取service从EurekaServer（服务发现）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Ribbon%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">4.</span> <span class="toc-text">
          Ribbon负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%8E%9F%E7%90%86"><span class="toc-number">4.1.</span> <span class="toc-text">
          负载均衡原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5"><span class="toc-number">4.2.</span> <span class="toc-text">
          负载均衡策略</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%87%92%E5%8A%A0%E8%BD%BD%E5%92%8C%E9%A5%A5%E9%A5%BF%E5%8A%A0%E8%BD%BD"><span class="toc-number">4.3.</span> <span class="toc-text">
          懒加载和饥饿加载</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Nacos%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="toc-number">5.</span> <span class="toc-text">
          Nacos注册中心</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8-1"><span class="toc-number">5.1.</span> <span class="toc-text">
          快速入门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%AE%89%E8%A3%85Nacos"><span class="toc-number">5.1.1.</span> <span class="toc-text">
          1.安装Nacos</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%8E%E5%8F%91%E7%8E%B0"><span class="toc-number">5.1.2.</span> <span class="toc-text">
          2.服务注册与发现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%9C%8D%E5%8A%A1%E9%9B%86%E7%BE%A4%E5%B1%9E%E6%80%A7"><span class="toc-number">5.1.3.</span> <span class="toc-text">
          3.服务集群属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-NacosRule%E6%9C%8D%E5%8A%A1%E9%9B%86%E7%BE%A4%E4%BC%98%E5%85%88%E7%BA%A7"><span class="toc-number">5.1.4.</span> <span class="toc-text">
          4.NacosRule服务集群优先级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E6%A0%B9%E6%8D%AE%E6%9D%83%E9%87%8D%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">5.1.5.</span> <span class="toc-text">
          5.根据权重负载均衡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E7%8E%AF%E5%A2%83%E9%9A%94%E7%A6%BBnamespace"><span class="toc-number">5.1.6.</span> <span class="toc-text">
          6.环境隔离namespace</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nacos%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E7%BB%86%E8%8A%82%E5%88%86%E6%9E%90"><span class="toc-number">5.2.</span> <span class="toc-text">
          Nacos注册中心细节分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%B4%E6%97%B6%E5%AE%9E%E4%BE%8B%E5%92%8C%E9%9D%9E%E4%B8%B4%E6%97%B6%E5%AE%9E%E4%BE%8B"><span class="toc-number">5.2.1.</span> <span class="toc-text">
          临时实例和非临时实例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nacos%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86"><span class="toc-number">5.3.</span> <span class="toc-text">
          Nacos配置管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AENacos%E9%85%8D%E7%BD%AE"><span class="toc-number">5.3.1.</span> <span class="toc-text">
          配置Nacos配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96Nacos%E9%85%8D%E7%BD%AE"><span class="toc-number">5.3.2.</span> <span class="toc-text">
          读取Nacos配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%83%AD%E6%9B%B4%E6%96%B0Nacos%E9%85%8D%E7%BD%AE"><span class="toc-number">5.3.3.</span> <span class="toc-text">
          热更新Nacos配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E5%85%B1%E4%BA%AB"><span class="toc-number">5.3.4.</span> <span class="toc-text">
          多环境配置共享</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nacos%E9%9B%86%E7%BE%A4"><span class="toc-number">5.4.</span> <span class="toc-text">
          Nacos集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Nacos%E9%9B%86%E7%BE%A4%E7%BB%93%E6%9E%84%E5%9B%BE"><span class="toc-number">5.4.1.</span> <span class="toc-text">
          1.Nacos集群结构图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%90%AD%E5%BB%BA%E9%9B%86%E7%BE%A4%EF%BC%9A%E6%AD%A5%E9%AA%A4"><span class="toc-number">5.4.2.</span> <span class="toc-text">
          2.搭建集群：步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%B5%8B%E8%AF%95Nacos%E9%9B%86%E7%BE%A4"><span class="toc-number">5.4.3.</span> <span class="toc-text">
          3.测试Nacos集群</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Feign%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8"><span class="toc-number">6.</span> <span class="toc-text">
          Feign远程调用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#RestTemplate%E6%96%B9%E5%BC%8F%E8%B0%83%E7%94%A8%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">6.1.</span> <span class="toc-text">
          RestTemplate方式调用存在的问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Feign%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="toc-number">6.2.</span> <span class="toc-text">
          Feign的概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8-2"><span class="toc-number">6.3.</span> <span class="toc-text">
          快速入门</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89Feign%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="toc-number">6.4.</span> <span class="toc-text">
          自定义Feign的配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E5%BC%8F%E4%B8%80%EF%BC%9A%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="toc-number">6.4.1.</span> <span class="toc-text">
          方式一：配置文件的方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E5%BC%8F%E4%BA%8C%EF%BC%9AJava%E4%BB%A3%E7%A0%81%E7%9A%84%E6%96%B9%E5%BC%8F%EF%BC%8C%E9%9C%80%E8%A6%81%E5%A3%B0%E6%98%8E%E4%B8%80%E4%B8%AABean"><span class="toc-number">6.4.2.</span> <span class="toc-text">
          方式二：Java代码的方式，需要声明一个Bean</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Feign%E7%9A%84%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="toc-number">6.5.</span> <span class="toc-text">
          Feign的性能优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Feign%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">6.6.</span> <span class="toc-text">
          Feign的最佳实践</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Gateway%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3"><span class="toc-number">7.</span> <span class="toc-text">
          Gateway服务网关</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E5%85%B3%E7%9A%84%E5%8A%9F%E8%83%BD"><span class="toc-number">7.1.</span> <span class="toc-text">
          网关的功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E5%85%B3%E6%8A%80%E6%9C%AF%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">7.2.</span> <span class="toc-text">
          网关技术的实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%EF%BC%9A%E6%90%AD%E5%BB%BA%E7%BD%91%E5%85%B3"><span class="toc-number">7.3.</span> <span class="toc-text">
          快速入门：搭建网关</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E6%96%AD%E8%A8%80%E5%B7%A5%E5%8E%82%EF%BC%9ARoute-Predicate-Factory"><span class="toc-number">7.4.</span> <span class="toc-text">
          路由断言工厂：Route Predicate Factory</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E8%BF%87%E6%BB%A4%E5%99%A8%EF%BC%9AGatewayFilter"><span class="toc-number">7.5.</span> <span class="toc-text">
          路由过滤器：GatewayFilter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E8%BF%87%E6%BB%A4%E5%99%A8%EF%BC%9AGlobalFilter"><span class="toc-number">7.6.</span> <span class="toc-text">
          全局过滤器：GlobalFilter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E5%99%A8%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"><span class="toc-number">7.7.</span> <span class="toc-text">
          过滤器执行顺序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86"><span class="toc-number">7.8.</span> <span class="toc-text">
          跨域问题处理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RabbitMQ%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-number">8.</span> <span class="toc-text">
          RabbitMQ消息队列</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E5%92%8C%E5%BC%82%E6%AD%A5"><span class="toc-number">8.1.</span> <span class="toc-text">
          同步和异步</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E8%B0%83%E7%94%A8%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">8.1.1.</span> <span class="toc-text">
          同步调用存在的问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E8%B0%83%E7%94%A8%E6%96%B9%E6%A1%88"><span class="toc-number">8.1.2.</span> <span class="toc-text">
          异步调用方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E4%BC%98%E5%8A%BF"><span class="toc-number">8.1.3.</span> <span class="toc-text">
          事件驱动优势</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E7%9A%84%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-number">8.2.</span> <span class="toc-text">
          常用的消息队列</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RabbitMQ"><span class="toc-number">8.3.</span> <span class="toc-text">
          RabbitMQ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85RabbitMQ"><span class="toc-number">8.4.</span> <span class="toc-text">
          安装RabbitMQ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E6%B6%88%E6%81%AF%E6%A8%A1%E5%9E%8B"><span class="toc-number">8.5.</span> <span class="toc-text">
          常见消息模型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-HelloWorld%E6%A1%88%E4%BE%8B%E2%80%94%E2%80%94%E7%AE%80%E5%8D%95%E9%98%9F%E5%88%97%E6%A8%A1%E5%9E%8B"><span class="toc-number">8.5.1.</span> <span class="toc-text">
          1. HelloWorld案例——简单队列模型</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringAMQP"><span class="toc-number">8.6.</span> <span class="toc-text">
          SpringAMQP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-1"><span class="toc-number">8.6.1.</span> <span class="toc-text">
          概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8-3"><span class="toc-number">8.6.2.</span> <span class="toc-text">
          快速入门</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Work-Queue%E5%B7%A5%E4%BD%9C%E9%98%9F%E5%88%97"><span class="toc-number">8.6.3.</span> <span class="toc-text">
          2. Work Queue工作队列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E9%A2%84%E5%8F%96%E9%99%90%E5%88%B6"><span class="toc-number">8.6.4.</span> <span class="toc-text">
          消费预取限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E5%B8%83%EF%BC%88Publish%EF%BC%89%E3%80%81%E8%AE%A2%E9%98%85%EF%BC%88Subscribe%EF%BC%89"><span class="toc-number">8.6.5.</span> <span class="toc-text">
          发布（Publish）、订阅（Subscribe）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-FanoutExchange"><span class="toc-number">8.6.5.1.</span> <span class="toc-text">
          3. FanoutExchange</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-DirectExchange"><span class="toc-number">8.6.5.2.</span> <span class="toc-text">
          4. DirectExchange</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-TopicExchange"><span class="toc-number">8.6.5.3.</span> <span class="toc-text">
          5. TopicExchange</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E8%BD%AC%E6%8D%A2%E5%99%A8"><span class="toc-number">8.6.6.</span> <span class="toc-text">
          消息转换器</span></a></li></ol></li></ol></li></ol></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/images/icons/head.jpg" alt="avatar"></div><p class="sidebar-ov-author__text">taoyyz</p></div><div class="sidebar-ov-social"><a class="sidebar-ov-social-item" href="https://weibo.com/6368186555/" target="_blank" rel="noopener" data-popover="微博：taoyyz" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-weibo"></i></span></a><a class="sidebar-ov-social-item" href="https://www.zhihu.com/people/taoyyz" target="_blank" rel="noopener" data-popover="知乎：taoyyz" data-popover-pos="up"><span class="sidebar-ov-social-item__icon">知</span></a><a class="sidebar-ov-social-item" href="https://space.bilibili.com/10111280" target="_blank" rel="noopener" data-popover="哔哩哔哩：宝贝球球ouo" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fas fa-tv"></i></span></a><a class="sidebar-ov-social-item" href="angelahape" target="_blank" rel="noopener" data-popover="微信：angelahape" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-weixin"></i></span></a><a class="sidebar-ov-social-item" href="tencent://message?uin=2655026691" target="_blank" rel="noopener" data-popover="QQ：2655026691" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-qq"></i></span></a><a class="sidebar-ov-social-item" href="https://www.youtube.com/channel/UCsz2-9ReY8ayMd-92rEGKFQ" target="_blank" rel="noopener" data-popover="Youtube：Xiaotao" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-youtube"></i></span></a></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">18</div><div class="sidebar-ov-state-item__name">归档</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">7</div><div class="sidebar-ov-state-item__name">分类</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">13</div><div class="sidebar-ov-state-item__name">标签</div></a></div><div></div><div id="tishi" style="text-align:center;user-select:none;font-weight:600;">本站已运行</div><span id="sitetime" style="text-align:center;display:block;user-select:none;">载入天数...<script language="javascript">const siteTime = () => {
  window.setTimeout(siteTime, 500);
  const startTime = Date.UTC(2021, 3, 10, 23, 0, 0); // 北京时间
  const currentTime = Date.now();
  const timeDifference = currentTime - startTime;

  const seconds = Math.floor((timeDifference / 1000) % 60);
  const minutes = Math.floor((timeDifference / 1000 / 60) % 60);
  const hours = Math.floor((timeDifference / (1000 * 60 * 60)) % 24);
  const days = Math.floor(timeDifference / (1000 * 60 * 60 * 24));
  const years = Math.floor(days / 365);
  const remainingDays = days % 365;

  let timeString = '';

  if (years > 0) {
    timeString += `${years}年`;
  }

  timeString += `${remainingDays}天${hours}时${minutes}分${seconds}秒`;

  document.getElementById("sitetime").innerHTML = timeString;
};

siteTime();
</script></span></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">你已阅读了 </span><span class="sidebar-reading-info__num">0</span><span class="sidebar-reading-info__perc">%</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2023</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>taoyyz小陶</span></div><div></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="搜索文章（支持多关键词，请用空格分隔）"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lazyload@2.0.0-rc.2/lazyload.min.js"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.json';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // 将 XML 转为 JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // 搜索对象（标题、内容）的权重，影响显示顺序
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // 根据空白字符分隔关键字
        var keywords = searchText.split(/[\s]+/);
        // 搜索结果
        var matchPosts = [];

        // 有多个关键字时，将原文字整个保存下来
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // 防止未输入字符时搜索
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // 没有标题的文章使用预设的 i18n 变量代替
            var title = (data.title && data.title.trim()) || '[ 文章无标题 ]';
            var titleLower = title && title.toLowerCase();
            // 删除 HTML 标签 和 所有空白字符
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // 删除重复的 /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // 标题中匹配到的关键词
            var titleHitSlice = [];
            // 内容中匹配到的关键词
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * 获取匹配的关键词的索引
              * @param {String} keyword 要匹配的关键字
              * @param {String} text 原文字
              * @param {Boolean} caseSensitive 是否区分大小写
              * @param {Number} weight 匹配对象的权重。权重大的优先显示
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // 每次匹配的开始索引
                var index = -1;     // 匹配到的索引值
                var result = [];    // 匹配结果

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // 索引位置相同的关键词，保留长度较长的
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // 按照匹配文字的索引的递增顺序排序
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * 给文本中匹配到的关键词添加标记，从而进行高亮显示
              * @param {String} text 原文本
              * @param {Array} hitSlice 匹配项的索引信息
              * @param {Number} start 开始索引
              * @param {Number} end 结束索引
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // 文章总的搜索权重
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // 标记匹配关键词后的标题
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // 标记匹配关键词后的内容
              var postContent;
              // 显示内容的长度
              var SHOW_WORD_LENGTH = 200;
              // 命中关键词前的字符显示长度
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // 截取匹配的第一个字符，前后共 200 个字符来显示
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // 未匹配到内容，直接截取前 200 个字符来显示
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // 按权重递增的顺序排序，使权重大的优先显示
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);

function safeOpenUrl(url) {
  var newTab = window.open();
  newTab.opener = null;
  newTab.location = url;
}

function extSearch(engine) {
  var engines = {
    google: 'https://www.google.com/search?q=',
    bing: 'https://cn.bing.com/search?q=',
    baidu: 'https://www.baidu.com/s?ie=UTF-8&wd=',
  };
  var host = window.location.host;
  var query = $('.search-input input').val().toLowerCase().trim();
  var uri = engines[engine] + query + ' site:' + host;

  if (query) {
    safeOpenUrl(uri);
  } else {
    Stun.utils.popAlert('warning', '请输入字符');
  }
}

var assistSearchList = window.CONFIG.assistSearch;

if (Array.isArray(assistSearchList)) {
  assistSearchList.forEach(function (name) {
    document.querySelector('.search-btns-item--' + name).addEventListener('click', function () {
      extSearch(name);
    }, false);
  });
}</script><script src="https://cdn.jsdelivr.net/npm/pjax@latest/pjax.min.js"></script><script>window.addEventListener('DOMContentLoaded', function () {
  var pjax = new Pjax({"selectors":["head title","#main",".pjax-reload"],"history":true,"scrollTo":false,"scrollRestoration":false,"cacheBust":false,"debug":false,"currentUrlFullReload":false,"timeout":0});
  // 加载进度条的计时器
  var loadingTimer = null;

  // 重置页面 Y 方向上的滚动偏移量
  document.addEventListener('pjax:send', function () {
    $('.header-nav-menu').removeClass('show');
    if (CONFIG.pjax && CONFIG.pjax.avoidBanner) {
      $('html').velocity('scroll', {
        duration: 500,
        offset: $('#header').height(),
        easing: 'easeInOutCubic'
      });
    }

    var loadingBarWidth = 20;
    var MAX_LOADING_WIDTH = 95;

    $('.loading-bar').addClass('loading');
    $('.loading-bar__progress').css('width', loadingBarWidth + '%');
    clearInterval(loadingTimer);
    loadingTimer = setInterval(function () {
      loadingBarWidth += 3;
      if (loadingBarWidth > MAX_LOADING_WIDTH) {
        loadingBarWidth = MAX_LOADING_WIDTH;
      }
      $('.loading-bar__progress').css('width', loadingBarWidth + '%');
    }, 500);
  }, false);

  window.addEventListener('pjax:complete', function () {
    clearInterval(loadingTimer);
    $('.loading-bar__progress').css('width', '100%');
    $('.loading-bar').removeClass('loading');
    setTimeout(function () {
      $('.loading-bar__progress').css('width', '0');
    }, 400);
    $('link[rel=prefetch], script[data-pjax-rm]').each(function () {
      $(this).remove();
    });
    $('script[data-pjax], #pjax-reload script').each(function () {
      $(this).parent().append($(this).remove());
    });

    if (Stun.utils.pjaxReloadBoot) {
      Stun.utils.pjaxReloadBoot();
    }
    if (Stun.utils.pjaxReloadScroll) {
      Stun.utils.pjaxReloadScroll();
    }
    if (Stun.utils.pjaxReloadSidebar) {
      Stun.utils.pjaxReloadSidebar();
    }
    if (false) {
      if (Stun.utils.pjaxReloadHeader) {
        Stun.utils.pjaxReloadHeader();
      }
      if (Stun.utils.pjaxReloadScrollIcon) {
        Stun.utils.pjaxReloadScrollIcon();
      }
      if (Stun.utils.pjaxReloadLocalSearch) {
        Stun.utils.pjaxReloadLocalSearch();
      }
    }
  }, false);
}, false);</script><div id="pjax-reload"></div><script src="/js/utils.js?v=2.6.2"></script><script src="/js/stun-boot.js?v=2.6.2"></script><script src="/js/scroll.js?v=2.6.2"></script><script src="/js/header.js?v=2.6.2"></script><script src="/js/sidebar.js?v=2.6.2"></script><script type="application/json" src="/search.json"></script></body></html>